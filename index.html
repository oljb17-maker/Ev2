<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EV Logbook ‚Äì Kairos Edition</title>

<style>
/* ================================================
   VARIABLES DEL TEMA (LIGHT / DARK)
================================================ */

:root {
  --bg: radial-gradient(circle at top, #283341 0%, #05070b 80%);
  --card: #111a22;
  --text: #f3f6fc;
  --text2: #8e9aac;
  --accent: #2ecc71;
  --accent-light: rgba(46, 204, 113, 0.18);
  --border: #1c232e;
  --input: #10161d;
}

body.light {
  --bg: radial-gradient(circle at top, #f3f5fa 0%, #dde3ef 80%);
  --card: #ffffff;
  --text: #0c0e10;
  --text2: #596579;
  --accent: #2ecc71;
  --accent-light: rgba(46, 204, 113, 0.16);
  --border: #cfd7e4;
  --input: #f1f4fa;
}

/* =======================================================
   RESETEO Y BASE
======================================================= */

* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

body {
  margin: 0;
  background: var(--bg);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--text);
  padding-bottom: 40px;
}

.app {
  max-width: 520px;
  margin: auto;
  padding: 15px;
}

/* =======================================================
   HEADER
======================================================= */

header.app-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.app-title-block h1 {
  margin: 0;
  font-size: 22px;
}
.app-title-block small {
  color: var(--text2);
  font-size: 12px;
}

.header-controls {
  display: flex;
  gap: 8px;
  align-items: center;
}

.header-select {
  padding: 6px 8px;
  font-size: 12px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--input);
  color: var(--text);
}

.icon-btn {
  width: 34px;
  height: 34px;
  border-radius: 50%;
  background: rgba(255,255,255,0.08);
  border: none;
  color: var(--text);
  font-size: 16px;
}

/* =======================================================
   VEHICLE BAR
======================================================= */

.vehicle-bar {
  margin-top: 14px;
  display: flex;
  gap: 8px;
}

.vehicle-bar select {
  flex: 1;
  padding: 9px 12px;
  border-radius: 999px;
  background: var(--input);
  color: var(--text);
  border: 1px solid var(--border);
  font-size: 13px;
}

.vehicle-bar button {
  padding: 7px 12px;
  font-size: 12px;
  border-radius: 999px;
  background: transparent;
  color: var(--text);
  border: 1px solid var(--border);
}

/* =======================================================
   TABS
======================================================= */

.tabs {
  margin-top: 14px;
  display: flex;
  background: rgba(0,0,0,0.3);
  padding: 3px;
  border-radius: 999px;
}

.tab {
  flex: 1;
  padding: 8px;
  border-radius: 999px;
  background: transparent;
  border: none;
  color: var(--text2);
  font-size: 14px;
}

.tab.active {
  background: var(--accent-light);
  color: var(--accent);
}

/* =======================================================
   CARDS
======================================================= */

.card {
  background: var(--card);
  margin-top: 14px;
  padding: 12px;
  border-radius: 14px;
  border: 1px solid var(--border);
}

.card h2 {
  margin: 0 0 8px;
  font-size: 16px;
}

/* =======================================================
   INPUTS
======================================================= */

.field {
  margin-bottom: 10px;
}

.field label {
  display: block;
  margin-bottom: 4px;
  color: var(--text2);
  font-size: 12px;
}

.field input {
  width: 100%;
  padding: 10px 9px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--input);
  color: var(--text);
  font-size: 14px;
}

.primary {
  width: 100%;
  padding: 10px;
  background: var(--accent);
  color: #041006;
  border: none;
  border-radius: 999px;
  font-size: 15px;
  margin-top: 12px;
  font-weight: 700;
}

.secondary-btn {
  padding: 8px;
  width: 100%;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 999px;
  margin-top: 6px;
  font-size: 13px;
}

/* =======================================================
   LISTAS
======================================================= */

.list {
  list-style: none;
  padding: 0;
  margin: 0;
  max-height: 260px;
  overflow-y: auto;
}

.list-item {
  padding: 6px 2px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  font-size: 12px;
}

/* =======================================================
   GAUGE DE BATER√çA / SOH
======================================================= */

.battery-row {
  display: flex;
  align-items: center;
  gap: 12px;
}

.battery-shell {
  position: relative;
  width: 90px;
  height: 32px;
  border-radius: 6px;
  background: #05090f;
  border: 2px solid var(--border);
}

.battery-level {
  position: absolute;
  top: 2px;
  left: 2px;
  bottom: 2px;
  width: 50%;
  border-radius: 4px;
  background: linear-gradient(90deg,#e74c3c,#f1c40f,#2ecc71);
  transition: width 0.6s ease-out;
}

.battery-tip {
  position: absolute;
  right: -7px;
  top: 7px;
  width: 6px;
  height: 16px;
  background: var(--border);
  border-radius: 4px;
}

/* =======================================================
   CANVAS - GR√ÅFICO
======================================================= */

.chart-wrapper {
  margin-top: 12px;
  border-radius: 14px;
  background: rgba(0,0,0,0.20);
  border: 1px solid var(--border);
  padding: 8px;
}

canvas {
  width: 100%;
  height: 120px;
}
</style>
</head>

<body>
<div class="app">

<header class="app-header">
  <div class="app-title-block">
    <h1 id="t_app_name">EV Logbook</h1>
    <small id="t_subtitle">Kairos Edition</small>
  </div>

  <div class="header-controls">
    <select id="langSelect" class="header-select">
      <option value="es">ES</option>
      <option value="en">EN</option>
    </select>

    <select id="unitSelect" class="header-select">
      <option value="km">KM</option>
      <option value="mi">MI</option>
    </select>

    <button id="themeToggle" class="icon-btn">üåô</button>
  </div>
</header>

<!-- BARRA DE VEH√çCULO -->
<div class="vehicle-bar">
  <select id="vehicleSelect"></select>
  <button id="newVehicleBtn">+ Veh√≠culo</button>
</div>

<!-- TABS -->
<nav class="tabs">
  <button class="tab active" data-tab="dashboard" id="tab_dashboard">Dashboard</button>
  <button class="tab" data-tab="charges" id="tab_charges">Cargas</button>
  <button class="tab" data-tab="vehicle" id="tab_vehicle">Veh√≠culo</button>
</nav>

<main>
  <!-- DASHBOARD -->
  <section id="dashboard" class="tab-panel" style="display:block;">
    <div class="card">
      <h2 id="t_summary_title">Resumen</h2>
      <div class="stats-grid" style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;">
        <div class="stat" style="padding:6px 8px;border-radius:10px;background:rgba(0,0,0,0.25);border:1px solid var(--border);">
          <div style="font-size:12px;color:var(--text2);" id="t_range_label">Autonom√≠a estimada</div>
          <div style="font-size:16px;font-weight:600;" id="stat-range">‚Äì</div>
        </div>
        <div class="stat" style="padding:6px 8px;border-radius:10px;background:rgba(0,0,0,0.25);border:1px solid var(--border);">
          <div style="font-size:12px;color:var(--text2);" id="t_cons_label">Consumo medio</div>
          <div style="font-size:16px;font-weight:600;" id="stat-consumption">‚Äì</div>
        </div>
        <div class="stat" style="padding:6px 8px;border-radius:10px;background:rgba(0,0,0,0.25);border:1px solid var(--border);">
          <div style="font-size:12px;color:var(--text2);" id="t_cost_label">Costo / 100 km</div>
          <div style="font-size:16px;font-weight:600;" id="stat-cost">‚Äì</div>
        </div>
        <div class="stat" style="padding:6px 8px;border-radius:10px;background:rgba(0,0,0,0.25);border:1px solid var(--border);">
          <div style="font-size:12px;color:var(--text2);" id="t_charges_label">Cargas registradas</div>
          <div style="font-size:16px;font-weight:600;" id="stat-charges">0</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 id="t_battery_title">Bater√≠a / SOH</h2>
      <div class="battery-row">
        <div class="battery-shell">
          <div class="battery-level" id="batteryLevel"></div>
          <div class="battery-tip"></div>
        </div>
        <div style="font-size:12px;">
          <div id="t_soh_label">SOH estimado: <strong id="sohValue">‚Äì</strong></div>
          <div id="t_deg_label">Degradaci√≥n: <strong id="degValue">‚Äì</strong></div>
        </div>
      </div>
      <p style="font-size:11px;color:var(--text2);margin-top:6px;" id="t_soh_hint">
        Basado en consumo real vs. dato de f√°brica. Es solo una estimaci√≥n aproximada.
      </p>
    </div>

    <div class="card">
      <h2 id="t_last_charge_title">√öltima carga</h2>
      <p id="last-charge">Crea un veh√≠culo y registra tu primera carga.</p>
      <button id="printBtn" class="secondary-btn">Imprimir / Exportar PDF</button>
    </div>

    <div class="card">
      <h2 id="t_chart_title">Historial visual</h2>
      <div class="chart-wrapper">
        <canvas id="consumptionChart"></canvas>
      </div>
      <p style="font-size:11px;color:var(--text2);margin-top:6px;" id="t_chart_hint">
        Consumo (kWh/100 km) de las √∫ltimas cargas del veh√≠culo seleccionado.
      </p>
    </div>
  </section>

  <!-- CARGAS -->
  <section id="charges" class="tab-panel" style="display:none;">
    <div class="card">
      <h2 id="t_new_charge_title">Nueva carga</h2>
      <p id="chargeVehicleHint" style="font-size:11px;color:var(--text2);"></p>
      <form id="charge-form" autocomplete="off">
        <div class="field">
          <label id="t_soc_start_label">% inicio</label>
          <input type="number" id="startSoc" min="0" max="100" required />
        </div>
        <div class="field">
          <label id="t_soc_end_label">% final</label>
          <input type="number" id="endSoc" min="0" max="100" required />
        </div>
        <div class="field">
          <label id="t_kwh_label">kWh entregados</label>
          <input type="number" step="0.01" id="kwh" required />
        </div>
        <div class="field">
          <label id="t_cost_total_label">Costo total</label>
          <input type="number" step="0.01" id="cost" required />
        </div>
        <div class="field">
          <label id="t_distance_since_label">Distancia desde la √∫ltima carga (km)</label>
          <input type="number" step="0.1" id="km" required />
        </div>
        <div class="field">
          <label id="t_notes_label">Notas (opcional)</label>
          <input type="text" id="notes" placeholder="EA - 150 kW, clima fr√≠o‚Ä¶" />
        </div>
        <button type="submit" class="primary" id="t_save_charge_btn">Guardar carga</button>
      </form>
    </div>

    <div class="card">
      <h2 id="t_history_title">Historial de cargas</h2>
      <ul id="charges-list" class="list"></ul>
    </div>
  </section>

  <!-- VEH√çCULO -->
  <section id="vehicle" class="tab-panel" style="display:none;">
    <div class="card">
      <h2 id="t_vehicle_data_title">Datos del veh√≠culo</h2>
      <form id="vehicle-form" autocomplete="off">
        <div class="field">
          <label id="t_alias_label">Nombre / Alias</label>
          <input type="text" id="alias" placeholder="Lucie" />
        </div>
        <div class="field">
          <label id="t_brand_label">Marca</label>
          <input type="text" id="brand" placeholder="Hyundai" />
        </div>
        <div class="field">
          <label id="t_model_label">Modelo</label>
          <input type="text" id="model" placeholder="Ioniq 5" />
        </div>
        <div class="field">
          <label id="t_year_label">A√±o</label>
          <input type="number" id="year" placeholder="2023" />
        </div>
        <div class="field">
          <label id="t_usable_label">Capacidad usable (kWh)</label>
          <input type="number" step="0.1" id="usableKwh" placeholder="72.6" />
        </div>
        <div class="field">
          <label id="t_rated_label">Consumo de ficha (kWh/100 km)</label>
          <input type="number" step="0.1" id="ratedConsumption" placeholder="17.0" />
        </div>
        <button type="submit" class="primary" id="t_save_vehicle_btn">Guardar veh√≠culo</button>
      </form>
    </div>

    <div class="card">
      <h2 id="t_backup_title">Copias de seguridad</h2>
      <button id="exportBtn" class="secondary-btn">Exportar backup (JSON)</button>
      <input type="file" id="importFile" accept="application/json" style="margin-top:8px;font-size:12px;" />
      <p style="font-size:11px;color:var(--text2);margin-top:6px;" id="t_backup_hint">
        Exporta un archivo JSON y gu√°rdalo en la nube. Para restaurar, selecci√≥nalo nuevamente aqu√≠.
      </p>
    </div>
  </section>
</main>

</div> <!-- cierre .app -->

<script>
/* =======================================================
   ESTADO Y CONFIGURACI√ìN BASE
======================================================= */

const STORAGE_KEY = "evlogbook-kairos-v3";
const KM_PER_MI = 1.60934;

let state = {
  theme: "dark",
  lang: "es",
  unit: "km",
  vehicles: [],
  activeVehicleId: null,
  // todas las distancias guardadas internamente en KM
  chargesByVehicle: {}
};

/* =======================================================
   UTILIDADES
======================================================= */

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const data = JSON.parse(raw);

    // Soporte para versiones viejas
    if (data.vehicle || data.charges) {
      const id = "veh-legacy";
      const v = Object.assign({ id, alias: "Mi EV" }, data.vehicle || {});
      state.vehicles = [v];
      state.activeVehicleId = id;
      state.chargesByVehicle[id] = (data.charges || []).map(c => ({
        ...c,
        kmBase: typeof c.km === "number" ? c.km : 0
      }));
    } else {
      state = Object.assign(state, data);
      // normalizar kmBase
      Object.keys(state.chargesByVehicle || {}).forEach(vid => {
        state.chargesByVehicle[vid] = (state.chargesByVehicle[vid] || []).map(c => {
          if (typeof c.kmBase === "number") return c;
          return Object.assign({}, c, { kmBase: typeof c.km === "number" ? c.km : 0 });
        });
      });
    }
  } catch (e) {
    console.warn("No se pudo cargar estado:", e);
  }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function getActiveVehicle() {
  return state.vehicles.find(v => v.id === state.activeVehicleId) || null;
}

function getActiveCharges() {
  return state.chargesByVehicle[state.activeVehicleId] || [];
}

function formatDate(dt) {
  const d = new Date(dt);
  return d.toLocaleString();
}

function kmToCurrent(km) {
  if (state.unit === "km") return km;
  return km / KM_PER_MI;
}
function currentToKm(dist) {
  if (state.unit === "km") return dist;
  return dist * KM_PER_MI;
}

function per100kmToUnit(v) {
  if (state.unit === "km") return v;
  return v * KM_PER_MI; // kWh/100mi
}

function costPer100kmToUnit(v) {
  if (state.unit === "km") return v;
  return v * KM_PER_MI; // costo/100mi
}

/* =======================================================
   I18N (TRADUCCIONES)
======================================================= */

const i18n = {
  es: {
    app_name: "EV Logbook",
    subtitle: "Kairos Edition",
    tab_dashboard: "Dashboard",
    tab_charges: "Cargas",
    tab_vehicle: "Veh√≠culo",
    summary_title: "Resumen",
    range_label: "Autonom√≠a estimada",
    cons_label_km: "Consumo medio (kWh/100 km)",
    cons_label_mi: "Consumo medio (kWh/100 mi)",
    cost_label_km: "Costo / 100 km",
    cost_label_mi: "Costo / 100 mi",
    charges_label: "Cargas registradas",
    battery_title: "Bater√≠a / SOH",
    soh_label: "SOH estimado:",
    deg_label: "Degradaci√≥n:",
    soh_hint: "Basado en consumo real vs. dato de f√°brica. Es solo una estimaci√≥n aproximada.",
    last_charge_title: "√öltima carga",
    last_charge_empty: "Crea un veh√≠culo y registra tu primera carga.",
    chart_title: "Historial visual",
    chart_hint_km: "Consumo (kWh/100 km) de las √∫ltimas cargas del veh√≠culo seleccionado.",
    chart_hint_mi: "Consumo (kWh/100 mi) de las √∫ltimas cargas del veh√≠culo seleccionado.",
    new_charge_title: "Nueva carga",
    save_charge_btn: "Guardar carga",
    soc_start_label: "% inicio",
    soc_end_label: "% final",
    kwh_label: "kWh entregados",
    cost_total_label: "Costo total",
    distance_since_label_km: "Distancia desde la √∫ltima carga (km)",
    distance_since_label_mi: "Distancia desde la √∫ltima carga (mi)",
    notes_label: "Notas (opcional)",
    history_title: "Historial de cargas",
    vehicle_data_title: "Datos del veh√≠culo",
    alias_label: "Nombre / Alias",
    brand_label: "Marca",
    model_label: "Modelo",
    year_label: "A√±o",
    usable_label: "Capacidad usable (kWh)",
    rated_label_km: "Consumo de ficha (kWh/100 km)",
    rated_label_mi: "Consumo de ficha (kWh/100 mi)",
    save_vehicle_btn: "Guardar veh√≠culo",
    backup_title: "Copias de seguridad",
    backup_hint: "Exporta un archivo JSON y gu√°rdalo en la nube. Para restaurar, selecci√≥nalo nuevamente aqu√≠.",
    export_backup_btn: "Exportar backup (JSON)",
    hint_no_vehicle: "Crea tu primer veh√≠culo para empezar a registrar.",
    hint_no_charges: "A√∫n no hay cargas guardadas para este veh√≠culo.",
    hint_create_vehicle_first: "Primero crea un veh√≠culo en la pesta√±a "Veh√≠culo".",
    hint_charges_for: nombre => `Guardando cargas para: ${nombre}`,
    print_btn: "Imprimir / Exportar PDF",
    new_vehicle_btn: "+ Veh√≠culo",
    vehicle_select_placeholder: "Sin veh√≠culos -- crea uno",
    alert_vehicle_min: "Coloca al menos un alias o marca/modelo.",
    alert_vehicle_saved: "Veh√≠culo guardado.",
    alert_check_numbers: "Revisa los campos num√©ricos.",
    alert_create_vehicle_first: "Primero crea un veh√≠culo.",
    alert_backup_invalid: "Archivo de backup inv√°lido.",
    alert_backup_error: "Error al leer el backup.",
    alert_backup_restored: "Backup restaurado."
  },
  en: {
    app_name: "EV Logbook",
    subtitle: "Kairos Edition",
    tab_dashboard: "Dashboard",
    tab_charges: "Charges",
    tab_vehicle: "Vehicle",
    summary_title: "Summary",
    range_label: "Estimated range",
    cons_label_km: "Average consumption (kWh/100 km)",
    cons_label_mi: "Average consumption (kWh/100 mi)",
    cost_label_km: "Cost / 100 km",
    cost_label_mi: "Cost / 100 mi",
    charges_label: "Logged charges",
    battery_title: "Battery / SOH",
    soh_label: "Estimated SOH:",
    deg_label: "Degradation:",
    soh_hint: "Based on real consumption vs rated value. Only an approximate estimate.",
    last_charge_title: "Last charge",
    last_charge_empty: "Create a vehicle and log your first charge.",
    chart_title: "Visual history",
    chart_hint_km: "Consumption (kWh/100 km) for the last charges of the selected vehicle.",
    chart_hint_mi: "Consumption (kWh/100 mi) for the last charges of the selected vehicle.",
    new_charge_title: "New charge",
    save_charge_btn: "Save charge",
    soc_start_label: "% start",
    soc_end_label: "% end",
    kwh_label: "Delivered kWh",
    cost_total_label: "Total cost",
    distance_since_label_km: "Distance since last charge (km)",
    distance_since_label_mi: "Distance since last charge (mi)",
    notes_label: "Notes (optional)",
    history_title: "Charge history",
    vehicle_data_title: "Vehicle data",
    alias_label: "Name / Alias",
    brand_label: "Brand",
    model_label: "Model",
    year_label: "Year",
    usable_label: "Usable capacity (kWh)",
    rated_label_km: "Rated consumption (kWh/100 km)",
    rated_label_mi: "Rated consumption (kWh/100 mi)",
    save_vehicle_btn: "Save vehicle",
    backup_title: "Backups",
    backup_hint: "Export a JSON file and store it safely. To restore, select it again here.",
    export_backup_btn: "Export backup (JSON)",
    hint_no_vehicle: "Create your first vehicle to start logging.",
    hint_no_charges: "No charges saved yet for this vehicle.",
    hint_create_vehicle_first: "Create a vehicle in the "Vehicle" tab first.",
    hint_charges_for: name => `Logging charges for: ${name}`,
    print_btn: "Print / Export PDF",
    new_vehicle_btn: "+ Vehicle",
    vehicle_select_placeholder: "No vehicles -- create one",
    alert_vehicle_min: "Enter at least an alias or brand/model.",
    alert_vehicle_saved: "Vehicle saved.",
    alert_check_numbers: "Please check the numeric fields.",
    alert_create_vehicle_first: "Create a vehicle first.",
    alert_backup_invalid: "Invalid backup file.",
    alert_backup_error: "Error reading backup file.",
    alert_backup_restored: "Backup restored."
  }
};

function t(key, ...args) {
  const langPack = i18n[state.lang] || i18n.es;
  const val = langPack[key];
  if (typeof val === "function") return val(...args);
  return val ?? key;
}

/* =======================================================
   REFERENCIAS DOM
======================================================= */

const langSelect = document.getElementById("langSelect");
const unitSelect = document.getElementById("unitSelect");
const themeToggle = document.getElementById("themeToggle");

const vehicleSelect = document.getElementById("vehicleSelect");
const newVehicleBtn = document.getElementById("newVehicleBtn");

const tabButtons = document.querySelectorAll(".tab");
const panels = document.querySelectorAll(".tab-panel");

const statRange = document.getElementById("stat-range");
const statCons = document.getElementById("stat-consumption");
const statCost = document.getElementById("stat-cost");
const statCharges = document.getElementById("stat-charges");
const lastChargeText = document.getElementById("last-charge");
const batteryLevelEl = document.getElementById("batteryLevel");
const sohValue = document.getElementById("sohValue");
const degValue = document.getElementById("degValue");
const chartCanvas = document.getElementById("consumptionChart");

const chargeForm = document.getElementById("charge-form");
const chargesList = document.getElementById("charges-list");
const chargeVehicleHint = document.getElementById("chargeVehicleHint");

const vehicleForm = document.getElementById("vehicle-form");
const exportBtn = document.getElementById("exportBtn");
const importFile = document.getElementById("importFile");
const printBtn = document.getElementById("printBtn");

/* =======================================================
   APLICAR TEMA
======================================================= */

function applyTheme(theme) {
  state.theme = theme;
  if (theme === "light") {
    document.body.classList.add("light");
    themeToggle.textContent = "üåô";
  } else {
    document.body.classList.remove("light");
    themeToggle.textContent = "üåô"; // puedes poner ‚òÄÔ∏è si prefieres indicar cambiar a light
  }
}

/* =======================================================
   APLICAR IDIOMA / UNIDAD EN TEXTOS
======================================================= */

function applyTranslations() {
  document.getElementById("t_app_name").textContent = t("app_name");
  document.getElementById("t_subtitle").textContent = t("subtitle");
  document.getElementById("tab_dashboard").textContent = t("tab_dashboard");
  document.getElementById("tab_charges").textContent = t("tab_charges");
  document.getElementById("tab_vehicle").textContent = t("tab_vehicle");

  document.getElementById("t_summary_title").textContent = t("summary_title");
  document.getElementById("t_range_label").textContent = t("range_label");

  document.getElementById("t_cons_label").textContent =
    state.unit === "km" ? t("cons_label_km") : t("cons_label_mi");

  document.getElementById("t_cost_label").textContent =
    state.unit === "km" ? t("cost_label_km") : t("cost_label_mi");

  document.getElementById("t_charges_label").textContent = t("charges_label");
  document.getElementById("t_battery_title").textContent = t("battery_title");

  document.getElementById("t_soh_label").childNodes[0].nodeValue = t("soh_label") + " ";
  document.getElementById("t_deg_label").childNodes[0].nodeValue = t("deg_label") + " ";
  document.getElementById("t_soh_hint").textContent = t("soh_hint");

  document.getElementById("t_last_charge_title").textContent = t("last_charge_title");
  printBtn.textContent = t("print_btn");

  document.getElementById("t_chart_title").textContent = t("chart_title");
  document.getElementById("t_chart_hint").textContent =
    state.unit === "km" ? t("chart_hint_km") : t("chart_hint_mi");

  document.getElementById("t_new_charge_title").textContent = t("new_charge_title");
  document.getElementById("t_soc_start_label").textContent = t("soc_start_label");
  document.getElementById("t_soc_end_label").textContent = t("soc_end_label");
  document.getElementById("t_kwh_label").textContent = t("kwh_label");
  document.getElementById("t_cost_total_label").textContent = t("cost_total_label");

  document.getElementById("t_distance_since_label").textContent =
    state.unit === "km" ? t("distance_since_label_km") : t("distance_since_label_mi");

  document.getElementById("t_notes_label").textContent = t("notes_label");
  document.getElementById("t_save_charge_btn").textContent = t("save_charge_btn");
  document.getElementById("t_history_title").textContent = t("history_title");

  document.getElementById("t_vehicle_data_title").textContent = t("vehicle_data_title");
  document.getElementById("t_alias_label").textContent = t("alias_label");
  document.getElementById("t_brand_label").textContent = t("brand_label");
  document.getElementById("t_model_label").textContent = t("model_label");
  document.getElementById("t_year_label").textContent = t("year_label");
  document.getElementById("t_usable_label").textContent = t("usable_label");
  document.getElementById("t_rated_label").textContent =
    state.unit === "km" ? t("rated_label_km") : t("rated_label_mi");
  document.getElementById("t_save_vehicle_btn").textContent = t("save_vehicle_btn");

  document.getElementById("t_backup_title").textContent = t("backup_title");
  document.getElementById("t_backup_hint").textContent = t("backup_hint");
  exportBtn.textContent = t("export_backup_btn");
  newVehicleBtn.textContent = t("new_vehicle_btn");
}

/* =======================================================
   VEH√çCULOS
======================================================= */

function renderVehicleSelect() {
  vehicleSelect.innerHTML = "";
  if (!state.vehicles.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = t("vehicle_select_placeholder");
    vehicleSelect.appendChild(opt);
    vehicleSelect.disabled = true;
    return;
  }
  vehicleSelect.disabled = false;

  state.vehicles.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.id;
    opt.textContent = v.alias || (v.brand + " " + v.model) || "EV";
    vehicleSelect.appendChild(opt);
  });

  if (!state.activeVehicleId) {
    state.activeVehicleId = state.vehicles[0].id;
  }
  vehicleSelect.value = state.activeVehicleId;
}

function renderVehicleForm() {
  const v = getActiveVehicle();
  vehicleForm.alias.value = v ? (v.alias || "") : "";
  vehicleForm.brand.value = v ? (v.brand || "") : "";
  vehicleForm.model.value = v ? (v.model || "") : "";
  vehicleForm.year.value = v ? (v.year || "") : "";
  vehicleForm.usableKwh.value = v ? (v.usableKwh || "") : "";
  vehicleForm.ratedConsumption.value = v ? (v.ratedConsumption || "") : "";
}

/* =======================================================
   CARGAS / DASHBOARD / C√ÅLCULOS
======================================================= */

let chartCtx = null;

function drawChart(values) {
  if (!chartCanvas) return;
  if (!chartCtx) chartCtx = chartCanvas.getContext("2d");

  const w = chartCanvas.width = chartCanvas.clientWidth;
  const h = chartCanvas.height = chartCanvas.clientHeight;
  const ctx = chartCtx;

  ctx.clearRect(0,0,w,h);

  if (!values || !values.length) {
    ctx.fillStyle = "#888";
    ctx.font = "12px system-ui";
    ctx.fillText(state.lang === "es" ? "Sin datos suficientes." : "Not enough data.", 10, h/2);
    return;
  }

  const maxVal = Math.max(...values);
  const minVal = Math.min(...values);
  const padding = 8;
  const usableW = w - padding*2;
  const usableH = h - padding*2;

  ctx.strokeStyle = "rgba(255,255,255,0.2)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padding, h-padding);
  ctx.lineTo(w-padding, h-padding);
  ctx.stroke();

  ctx.strokeStyle = "#2ecc71";
  ctx.lineWidth = 2;
  ctx.beginPath();
  values.forEach((v,i) => {
    const x = padding + (usableW * (i / Math.max(values.length-1,1)));
    const norm = (v - minVal) / (maxVal - minVal || 1);
    const y = padding + usableH*(1-norm);
    if (i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });
  ctx.stroke();
}

function updateChargeFormAvailability() {
  const active = getActiveVehicle();
  const inputs = chargeForm.querySelectorAll("input, button");
  if (!active) {
    inputs.forEach(el => el.disabled = true);
    chargeVehicleHint.textContent = t("hint_create_vehicle_first");
  } else {
    inputs.forEach(el => el.disabled = false);
    const label = active.alias || (active.brand + " " + active.model) || "EV";
    chargeVehicleHint.textContent = t("hint_charges_for", label);
  }
}

function renderChargesAndStats() {
  const v = getActiveVehicle();
  updateChargeFormAvailability();
  chargesList.innerHTML = "";

  if (!v) {
    chargesList.innerHTML = "<li class='list-item'>" + t("hint_no_vehicle") + "</li>";
    lastChargeText.textContent = t("hint_no_vehicle");
    statRange.textContent = "‚Äì";
    statCons.textContent = "‚Äì";
    statCost.textContent = "‚Äì";
    statCharges.textContent = "0";
    sohValue.textContent = "‚Äì";
    degValue.textContent = "‚Äì";
    batteryLevelEl.style.width = "25%";
    drawChart([]);
    return;
  }

  const charges = getActiveCharges();
  if (!charges.length) {
    chargesList.innerHTML = "<li class='list-item'>" + t("hint_no_charges") + "</li>";
    lastChargeText.textContent = t("hint_no_charges");
    statRange.textContent = "‚Äì";
    statCons.textContent = "‚Äì";
    statCost.textContent = "‚Äì";
    statCharges.textContent = "0";
    sohValue.textContent = "‚Äì";
    degValue.textContent = "‚Äì";
    batteryLevelEl.style.width = "40%";
    drawChart([]);
    return;
  }

  statCharges.textContent = String(charges.length);

  let totalKmBase = 0;
  let totalKwh = 0;
  let totalCost = 0;
  const chartValues = [];

  charges.slice().reverse().forEach(c => {
    totalKmBase += c.kmBase;
    totalKwh += c.kwh;
    totalCost += c.cost;

    const consPer100km = c.kmBase > 0 ? (c.kwh / (c.kmBase/100)) : 0;
    const consForUnit = per100kmToUnit(consPer100km);
    chartValues.push(consForUnit);

    const distShown = kmToCurrent(c.kmBase).toFixed(1);
    const unitTxt = state.unit;

    const effTxt = c.kmBase > 0
      ? consForUnit.toFixed(1) + " kWh/100 " + unitTxt
      : "‚Äì";

    const li = document.createElement("li");
    li.className = "list-item";
    li.innerHTML = "<strong>" + formatDate(c.date) + "</strong><br>" +
      "<span>" +
      c.startSoc + "% ‚Üí " + c.endSoc + "% | " +
      c.kwh + " kWh | " +
      c.cost + " $ | " +
      distShown + " " + unitTxt +
      " (" + effTxt + ")" +
      "</span>" +
      (c.notes ? "<br><span>" + c.notes + "</span>" : "");
    chargesList.appendChild(li);
  });

  const last = charges[charges.length-1];
  const lastConsPer100km = last.kmBase > 0 ? (last.kwh / (last.kmBase/100)) : 0;
  const lastConsForUnit = per100kmToUnit(lastConsPer100km);
  const lastDistShown = kmToCurrent(last.kmBase).toFixed(1);
  const unitTxt = state.unit;

  lastChargeText.innerHTML =
    "<strong>" + formatDate(last.date) + "</strong><br>" +
    last.startSoc + "% ‚Üí " + last.endSoc + "% | " +
    last.kwh + " kWh | " +
    last.cost + " $ | " +
    lastDistShown + " " + unitTxt + "<br>" +
    "<span>" + lastConsForUnit.toFixed(1) + " kWh/100 " + unitTxt + "</span>";

  if (totalKmBase > 0 && totalKwh > 0) {
    const avgPer100km = totalKwh / (totalKmBase/100);
    const avgForUnit = per100kmToUnit(avgPer100km);
    statCons.textContent = avgForUnit.toFixed(1) + " kWh/100 " + unitTxt;

    const costPerKm = totalCost / totalKmBase;
    const baseCost100km = costPerKm * 100;
    const costForUnit = costPer100kmToUnit(baseCost100km);
    statCost.textContent = costForUnit.toFixed(2) + " $ / 100 " + unitTxt;

    const usable = parseFloat(v.usableKwh || "0");
    if (usable > 0 && avgPer100km > 0) {
      const rangeKm = usable / (avgPer100km/100);
      const rangeShown = kmToCurrent(rangeKm);
      statRange.textContent = rangeShown.toFixed(0) + " " + unitTxt;
      // SOH
      const rated = parseFloat(v.ratedConsumption || "0"); // kWh/100 km base
      if (rated > 0) {
        const theoKm = usable / (rated/100);
        let soh = (rangeKm / theoKm)*100;
        soh = Math.max(50, Math.min(120, soh));
        const degr = 100 - soh;
        sohValue.textContent = soh.toFixed(1) + " %";
        degValue.textContent = degr.toFixed(1) + " %";
        const width = Math.max(15, Math.min(100, soh));
        batteryLevelEl.style.width = width + "%";
      } else {
        sohValue.textContent = "‚Äì";
        degValue.textContent = "‚Äì";
        batteryLevelEl.style.width = "50%";
      }
    } else {
      statRange.textContent = "‚Äì";
      sohValue.textContent = "‚Äì";
      degValue.textContent = "‚Äì";
      batteryLevelEl.style.width = "50%";
    }
  } else {
    statCons.textContent = "‚Äì";
    statCost.textContent = "‚Äì";
    statRange.textContent = "‚Äì";
    sohValue.textContent = "‚Äì";
    degValue.textContent = "‚Äì";
    batteryLevelEl.style.width = "50%";
  }

  drawChart(chartValues.reverse());
}

/* =======================================================
   EVENTOS
======================================================= */

tabButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    tabButtons.forEach(b => b.classList.remove("active"));
    panels.forEach(p => p.style.display = "none");
    btn.classList.add("active");
    const id = btn.dataset.tab;
    document.getElementById(id).style.display = "block";
  });
});

langSelect.addEventListener("change", () => {
  state.lang = langSelect.value;
  saveState();
  applyTranslations();
  renderVehicleSelect();
  renderVehicleForm();
  renderChargesAndStats();
});

unitSelect.addEventListener("change", () => {
  state.unit = unitSelect.value;
  saveState();
  applyTranslations();
  renderChargesAndStats();
});

themeToggle.addEventListener("click", () => {
  state.theme = state.theme === "dark" ? "light" : "dark";
  applyTheme(state.theme);
  saveState();
});

vehicleSelect.addEventListener("change", () => {
  state.activeVehicleId = vehicleSelect.value || null;
  saveState();
  renderVehicleForm();
  renderChargesAndStats();
});

newVehicleBtn.addEventListener("click", () => {
  state.activeVehicleId = null;
  renderVehicleForm();
  renderChargesAndStats();
});

vehicleForm.addEventListener("submit", e => {
  e.preventDefault();
  const alias = vehicleForm.alias.value.trim();
  const brand = vehicleForm.brand.value.trim();
  const model = vehicleForm.model.value.trim();
  const year = vehicleForm.year.value.trim();
  const usableKwh = vehicleForm.usableKwh.value.trim();
  const ratedConsumption = vehicleForm.ratedConsumption.value.trim();

  if (!alias && !brand && !model) {
    alert(t("alert_vehicle_min"));
    return;
  }

  if (!state.activeVehicleId) {
    const id = "veh-" + Date.now().toString(36);
    const v = { id, alias, brand, model, year, usableKwh, ratedConsumption };
    state.vehicles.push(v);
    state.activeVehicleId = id;
    state.chargesByVehicle[id] = [];
  } else {
    const idx = state.vehicles.findIndex(v => v.id === state.activeVehicleId);
    if (idx >= 0) {
      state.vehicles[idx] = Object.assign({}, state.vehicles[idx], {
        alias, brand, model, year, usableKwh, ratedConsumption
      });
    }
  }
  saveState();
  renderVehicleSelect();
  renderVehicleForm();
  renderChargesAndStats();
  alert(t("alert_vehicle_saved"));
});

chargeForm.addEventListener("submit", e => {
  e.preventDefault();
  const v = getActiveVehicle();
  if (!v) {
    alert(t("alert_create_vehicle_first"));
    return;
  }
  const startSoc = parseFloat(document.getElementById("startSoc").value);
  const endSoc = parseFloat(document.getElementById("endSoc").value);
  const kwh = parseFloat(document.getElementById("kwh").value);
  const cost = parseFloat(document.getElementById("cost").value);
  const dist = parseFloat(document.getElementById("km").value);
  const notes = document.getElementById("notes").value.trim();

  if ([startSoc,endSoc,kwh,cost,dist].some(v => isNaN(v))) {
    alert(t("alert_check_numbers"));
    return;
  }

  const kmBase = currentToKm(dist);

  const vid = state.activeVehicleId;
  if (!state.chargesByVehicle[vid]) state.chargesByVehicle[vid] = [];
  state.chargesByVehicle[vid].push({
    date: new Date().toISOString(),
    startSoc,
    endSoc,
    kwh,
    cost,
    kmBase,
    notes
  });

  saveState();
  chargeForm.reset();
  renderChargesAndStats();
});

exportBtn.addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ev-logbook-kairos-backup.json";
  a.click();
  URL.revokeObjectURL(url);
});

importFile.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (!data.vehicles || !data.chargesByVehicle) {
        alert(t("alert_backup_invalid"));
        return;
      }
      state = Object.assign(state, data);
      saveState();
      applyTheme(state.theme || "dark");
      langSelect.value = state.lang || "es";
      unitSelect.value = state.unit || "km";
      applyTranslations();
      renderVehicleSelect();
      renderVehicleForm();
      renderChargesAndStats();
      alert(t("alert_backup_restored"));
    } catch (err) {
      alert(t("alert_backup_error"));
    }
  };
  reader.readAsText(file);
});

printBtn.addEventListener("click", () => {
  window.print();
});

/* =======================================================
   INICIALIZACI√ìN
======================================================= */

loadState();
applyTheme(state.theme || "dark");
langSelect.value = state.lang || "es";
unitSelect.value = state.unit || "km";
applyTranslations();
renderVehicleSelect();
renderVehicleForm();
renderChargesAndStats();
</script>

</body>
</html>

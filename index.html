<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EV Logbook ‚Äì Kairos</title>
  <style>
    :root {
      --bg-gradient: radial-gradient(circle at top, #323b46 0, #05070b 60%);
      --card-bg: #111821;
      --accent: #2ecc71;
      --accent-soft: rgba(46, 204, 113, 0.15);
      --border: #1d2733;
      --text-main: #f4f6fb;
      --text-muted: #8b97aa;
      --danger: #e74c3c;
      --input-bg: #0b1017;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      background: var(--bg-gradient);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
    }

    body.light {
      --card-bg: #ffffff;
      --border: #d3dbe8;
      --text-main: #02040a;
      --text-muted: #5c6a80;
      --bg-gradient: radial-gradient(circle at top, #f6f8fc 0, #d9e1ef 60%);
      --accent-soft: rgba(46, 204, 113, 0.18);
      --input-bg: #f4f6fc;
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 12px 10px 16px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .app-header-left {
      display: flex;
      flex-direction: column;
    }
    .app-header h1 {
      font-size: 20px;
      margin: 0;
    }
    .subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .icon-btn {
      border: none;
      background: rgba(0,0,0,0.2);
      border-radius: 999px;
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      cursor: pointer;
    }

    .vehicle-bar {
      margin-bottom: 10px;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .vehicle-bar select {
      flex: 1;
      border-radius: 999px;
      padding: 7px 10px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size: 13px;
    }
    .ghost {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-main);
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .tabs {
      display: flex;
      border-radius: 999px;
      background: rgba(0,0,0,0.5);
      padding: 3px;
      margin-bottom: 12px;
    }
    .tab {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-muted);
      padding: 6px 0;
      font-size: 13px;
      border-radius: 999px;
      cursor: pointer;
    }
    .tab.active {
      background: var(--accent-soft);
      color: var(--accent);
    }

    main {
      display: block;
    }

    .card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid var(--border);
      box-shadow: 0 10px 20px rgba(0,0,0,0.45);
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
    }
    .stat {
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
    }
    .stat .label {
      font-size: 11px;
      color: var(--text-muted);
    }
    .stat .value {
      font-size: 15px;
      font-weight: 600;
    }

    .field {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
    }
    .field label {
      font-size: 12px;
      margin-bottom: 2px;
      color: var(--text-muted);
    }
    .field input {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 7px 9px;
      font-size: 13px;
      background: var(--input-bg);
      color: var(--text-main);
    }
    .field input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .primary {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 9px 0;
      background: var(--accent);
      color: #030507;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
    }
    .primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.6) inset;
    }

    .secondary-btn {
      width: 100%;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 7px 0;
      background: transparent;
      color: var(--text-main);
      font-size: 13px;
      cursor: pointer;
      margin-top: 6px;
    }

    .list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 260px;
      overflow-y: auto;
    }
    .list-item {
      padding: 6px 4px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      font-size: 12px;
    }
    .list-item:last-child {
      border-bottom: none;
    }
    .list-item strong {
      font-size: 13px;
    }
    .list-item span {
      color: var(--text-muted);
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* bater√≠a / SOH */
    .battery-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }
    .battery-shell {
      position: relative;
      width: 90px;
      height: 32px;
      border-radius: 6px;
      border: 2px solid var(--border);
      background: #05070b;
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,0.05);
    }
    .battery-tip {
      position: absolute;
      right: -8px;
      top: 8px;
      width: 6px;
      height: 16px;
      border-radius: 3px;
      background: var(--border);
    }
    .battery-level {
      position: absolute;
      left: 2px;
      top: 2px;
      bottom: 2px;
      width: 20%;
      border-radius: 4px;
      background: linear-gradient(90deg,#e74c3c,#f1c40f,#2ecc71);
      transition: width 0.6s ease-out;
    }
    .battery-info div {
      font-size: 12px;
      margin-bottom: 2px;
    }

    /* gr√°fico simple */
    .chart-wrapper {
      margin-top: 6px;
      border-radius: 10px;
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--border);
      padding: 6px;
    }
    canvas {
      width: 100%;
      height: 120px;
      display: block;
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    @media (min-width: 600px) {
      .app {
        padding-top: 24px;
      }
    }

    @media print {
      body {
        background: #ffffff;
      }
      .tabs, .vehicle-bar, .icon-btn, .ghost, .primary, .secondary-btn {
        display: none !important;
      }
      .card {
        box-shadow: none;
        border-radius: 0;
        border: 1px solid #ccc;
      }
      .app {
        max-width: 100%;
        padding: 0;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <div class="app-header-left">
      <h1>EV Logbook</h1>
      <span class="subtitle">Kairos Edition</span>
    </div>
    <button id="themeToggle" class="icon-btn" aria-label="Cambiar tema">‚òÄÔ∏è</button>
  </header>

  <div class="vehicle-bar">
    <select id="vehicleSelect"></select>
    <button id="newVehicleBtn" class="ghost">+ Veh√≠culo</button>
  </div>

  <nav class="tabs">
    <button class="tab active" data-tab="dashboard">Dashboard</button>
    <button class="tab" data-tab="charges">Cargas</button>
    <button class="tab" data-tab="vehicle">Veh√≠culo</button>
  </nav>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="tab-panel active">
      <div class="card">
        <h2>Resumen</h2>
        <div class="stats-grid">
          <div class="stat">
            <span class="label">Autonom√≠a estimada</span>
            <span class="value" id="stat-range">‚Äì</span>
          </div>
          <div class="stat">
            <span class="label">Consumo medio</span>
            <span class="value" id="stat-consumption">‚Äì</span>
          </div>
          <div class="stat">
            <span class="label">Costo / 100 km</span>
            <span class="value" id="stat-cost">‚Äì</span>
          </div>
          <div class="stat">
            <span class="label">Cargas registradas</span>
            <span class="value" id="stat-charges">0</span>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Bater√≠a</h2>
        <div class="battery-row">
          <div class="battery-shell">
            <div class="battery-level" id="batteryLevel"></div>
            <div class="battery-tip"></div>
          </div>
          <div class="battery-info">
            <div>SOH estimado: <strong id="sohValue">‚Äì</strong></div>
            <div>Degradaci√≥n: <strong id="degValue">‚Äì</strong></div>
          </div>
        </div>
        <p class="hint">Basado en consumo real vs. consumo de f√°brica; es una estimaci√≥n aproximada.</p>
      </div>

      <div class="card">
        <h2>√öltima carga</h2>
        <p id="last-charge">Crea un veh√≠culo y registra tu primera carga.</p>
        <button id="printBtn" class="secondary-btn">Imprimir / Exportar PDF</button>
      </div>

      <div class="card">
        <h2>Historial visual</h2>
        <div class="chart-wrapper">
          <canvas id="consumptionChart"></canvas>
        </div>
        <p class="hint">Gr√°fico de consumo (kWh/100 km) de las √∫ltimas cargas del veh√≠culo seleccionado.</p>
      </div>
    </section>

    <!-- CARGAS -->
    <section id="charges" class="tab-panel">
      <div class="card">
        <h2>Nueva carga</h2>
        <p class="hint" id="chargeVehicleHint"></p>
        <form id="charge-form" autocomplete="off">
          <div class="field">
            <label>% inicio</label>
            <input type="number" id="startSoc" min="0" max="100" required />
          </div>
          <div class="field">
            <label>% final</label>
            <input type="number" id="endSoc" min="0" max="100" required />
          </div>
          <div class="field">
            <label>kWh entregados</label>
            <input type="number" step="0.01" id="kwh" required />
          </div>
          <div class="field">
            <label>Costo total (moneda local)</label>
            <input type="number" step="0.01" id="cost" required />
          </div>
          <div class="field">
            <label>Km recorridos desde la √∫ltima carga</label>
            <input type="number" step="0.1" id="km" required />
          </div>
          <div class="field">
            <label>Notas (opcional)</label>
            <input type="text" id="notes" placeholder="EA - 150 kW, clima fr√≠o‚Ä¶" />
          </div>
          <button type="submit" class="primary">Guardar carga</button>
        </form>
      </div>

      <div class="card">
        <h2>Historial de cargas</h2>
        <ul id="charges-list" class="list"></ul>
      </div>
    </section>

    <!-- VEH√çCULO -->
    <section id="vehicle" class="tab-panel">
      <div class="card">
        <h2>Datos del veh√≠culo</h2>
        <form id="vehicle-form" autocomplete="off">
          <div class="field">
            <label>Nombre / Alias (ej: Lucie)</label>
            <input type="text" id="alias" placeholder="Lucie" />
          </div>
          <div class="field">
            <label>Marca</label>
            <input type="text" id="brand" placeholder="Hyundai" />
          </div>
          <div class="field">
            <label>Modelo</label>
            <input type="text" id="model" placeholder="Ioniq 5" />
          </div>
          <div class="field">
            <label>A√±o</label>
            <input type="number" id="year" placeholder="2023" />
          </div>
          <div class="field">
            <label>Capacidad bater√≠a usable (kWh)</label>
            <input type="number" step="0.1" id="usableKwh" placeholder="72.6" />
          </div>
          <div class="field">
            <label>Consumo WLTP / EPA (kWh/100 km)</label>
            <input type="number" step="0.1" id="ratedConsumption" placeholder="17.0" />
          </div>
          <button type="submit" class="primary">Guardar veh√≠culo</button>
        </form>
      </div>

      <div class="card">
        <h2>Copias de seguridad</h2>
        <button id="exportBtn" class="secondary-btn">Exportar backup (JSON)</button>
        <input type="file" id="importFile" accept="application/json" style="margin-top:8px;font-size:12px;" />
        <p class="hint">Puedes guardar el JSON en la nube o envi√°rtelo por correo. Para restaurar, selecciona el archivo y se cargar√°.</p>
      </div>
    </section>
  </main>
</div>

<script>
  const STORAGE_KEY = "evlogbook-kairos-v2";

  let state = {
    theme: "dark",
    vehicles: [],
    activeVehicleId: null,
    chargesByVehicle: {}
  };

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);

      // Si viene del formato viejo (un solo veh√≠culo)
      if (parsed.vehicle || parsed.charges) {
        const id = "veh-1";
        const v = Object.assign(
          {
            id,
            alias: (parsed.vehicle && (parsed.vehicle.alias || parsed.vehicle.model)) || "Mi EV"
          },
          parsed.vehicle || {}
        );
        state.vehicles = [v];
        state.activeVehicleId = id;
        state.chargesByVehicle[id] = parsed.charges || [];
      } else if (parsed.vehicles) {
        state = parsed;
      }
    } catch (e) {
      console.warn("No se pudo cargar el estado:", e);
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function getActiveVehicle() {
    return state.vehicles.find(v => v.id === state.activeVehicleId) || null;
  }

  function getActiveCharges() {
    return state.chargesByVehicle[state.activeVehicleId] || [];
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleString();
  }

  // Tabs
  const tabs = document.querySelectorAll(".tab");
  const panels = document.querySelectorAll(".tab-panel");

  tabs.forEach(btn => {
    btn.addEventListener("click", () => {
      tabs.forEach(t => t.classList.remove("active"));
      panels.forEach(p => p.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });

  const themeToggle = document.getElementById("themeToggle");
  function applyTheme(mode) {
    state.theme = mode;
    if (mode === "light") {
      document.body.classList.add("light");
      themeToggle.textContent = "üåô";
    } else {
      document.body.classList.remove("light");
      themeToggle.textContent = "‚òÄÔ∏è";
    }
  }
  themeToggle.addEventListener("click", () => {
    const next = state.theme === "light" ? "dark" : "light";
    applyTheme(next);
    saveState();
  });

  // Veh√≠culos
  const vehicleSelect = document.getElementById("vehicleSelect");
  const newVehicleBtn = document.getElementById("newVehicleBtn");
  const vehicleForm = document.getElementById("vehicle-form");

  function renderVehicleSelect() {
    vehicleSelect.innerHTML = "";
    if (!state.vehicles.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Sin veh√≠culos ‚Äî crea uno";
      vehicleSelect.appendChild(opt);
      vehicleSelect.disabled = true;
      return;
    }
    vehicleSelect.disabled = false;
    state.vehicles.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.id;
      opt.textContent = v.alias || (v.brand + " " + v.model);
      vehicleSelect.appendChild(opt);
    });
    if (!state.activeVehicleId) {
      state.activeVehicleId = state.vehicles[0].id;
    }
    vehicleSelect.value = state.activeVehicleId;
  }

  vehicleSelect.addEventListener("change", () => {
    state.activeVehicleId = vehicleSelect.value || null;
    saveState();
    renderVehicleForm();
    renderCharges();
  });

  newVehicleBtn.addEventListener("click", () => {
    state.activeVehicleId = null;
    vehicleSelect.value = "";
    renderVehicleForm();
    renderCharges();
  });

  function renderVehicleForm() {
    const v = getActiveVehicle();
    vehicleForm.alias.value = v ? (v.alias || "") : "";
    vehicleForm.brand.value = v ? (v.brand || "") : "";
    vehicleForm.model.value = v ? (v.model || "") : "";
    vehicleForm.year.value = v ? (v.year || "") : "";
    vehicleForm.usableKwh.value = v ? (v.usableKwh || "") : "";
    vehicleForm.ratedConsumption.value = v ? (v.ratedConsumption || "") : "";
  }

  vehicleForm.addEventListener("submit", e => {
    e.preventDefault();
    const alias = vehicleForm.alias.value.trim();
    const brand = vehicleForm.brand.value.trim();
    const model = vehicleForm.model.value.trim();
    const year  = vehicleForm.year.value.trim();
    const usableKwh = vehicleForm.usableKwh.value.trim();
    const ratedConsumption = vehicleForm.ratedConsumption.value.trim();

    if (!brand && !model && !alias) {
      alert("Coloca al menos un alias o marca/modelo.");
      return;
    }

    if (!state.activeVehicleId) {
      const id = "veh-" + Date.now().toString(36);
      const v = { id, alias, brand, model, year, usableKwh, ratedConsumption };
      state.vehicles.push(v);
      state.activeVehicleId = id;
      state.chargesByVehicle[id] = [];
    } else {
      const idx = state.vehicles.findIndex(v => v.id === state.activeVehicleId);
      if (idx >= 0) {
        state.vehicles[idx] = Object.assign({}, state.vehicles[idx], {
          alias, brand, model, year, usableKwh, ratedConsumption
        });
      }
    }

    saveState();
    renderVehicleSelect();
    renderVehicleForm();
    renderCharges();
    alert("Veh√≠culo guardado.");
  });

  // Cargas
  const chargeForm = document.getElementById("charge-form");
  const chargesList = document.getElementById("charges-list");
  const lastChargeText = document.getElementById("last-charge");
  const chargeVehicleHint = document.getElementById("chargeVehicleHint");

  const statRange = document.getElementById("stat-range");
  const statCons = document.getElementById("stat-consumption");
  const statCost = document.getElementById("stat-cost");
  const statCharges = document.getElementById("stat-charges");

  const sohValue = document.getElementById("sohValue");
  const degValue = document.getElementById("degValue");
  const batteryLevelEl = document.getElementById("batteryLevel");

  const chartCanvas = document.getElementById("consumptionChart");
  let chartCtx = null;

  function updateChargeFormAvailability() {
    const active = getActiveVehicle();
    const inputs = chargeForm.querySelectorAll("input, button");
    if (!active) {
      inputs.forEach(el => el.disabled = true);
      chargeVehicleHint.textContent = "Primero crea un veh√≠culo en la pesta√±a ‚ÄúVeh√≠culo‚Äù.";
    } else {
      inputs.forEach(el => el.disabled = false);
      chargeVehicleHint.textContent = "Guardando cargas para: " + (active.alias || (active.brand + " " + active.model));
    }
  }

  function renderCharges() {
    const active = getActiveVehicle();
    updateChargeFormAvailability();

    chargesList.innerHTML = "";
    if (!active) {
      chargesList.innerHTML = "<li class='list-item'><span>Sin veh√≠culo activo.</span></li>";
      lastChargeText.textContent = "Crea tu primer veh√≠culo para empezar a registrar.";
      statCharges.textContent = "0";
      statRange.textContent = "‚Äì";
      statCons.textContent = "‚Äì";
      statCost.textContent = "‚Äì";
      sohValue.textContent = "‚Äì";
      degValue.textContent = "‚Äì";
      batteryLevelEl.style.width = "15%";
      drawChart([]);
      return;
    }

    const charges = getActiveCharges();
    if (!charges.length) {
      chargesList.innerHTML = "<li class='list-item'><span>A√∫n no hay cargas guardadas para este veh√≠culo.</span></li>";
      lastChargeText.textContent = "Registra tu primera carga para ver estad√≠sticas.";
      statCharges.textContent = "0";
      statRange.textContent = "‚Äì";
      statCons.textContent = "‚Äì";
      statCost.textContent = "‚Äì";
      sohValue.textContent = "‚Äì";
      degValue.textContent = "‚Äì";
      batteryLevelEl.style.width = "15%";
      drawChart([]);
      return;
    }

    statCharges.textContent = charges.length.toString();

    let totalKm = 0;
    let totalKwh = 0;
    let totalCost = 0;
    const dataForChart = [];

    charges.slice().reverse().forEach(c => {
      totalKm += Number(c.km);
      totalKwh += Number(c.kwh);
      totalCost += Number(c.cost);

      const li = document.createElement("li");
      li.className = "list-item";
      const eff = c.km && c.kwh ? (c.kwh / (c.km / 100)).toFixed(1) : "‚Äì";
      dataForChart.push(parseFloat(eff === "‚Äì" ? 0 : eff));
      li.innerHTML = `
        <strong>${formatDate(c.date)}</strong><br>
        <span>${c.startSoc}% ‚Üí ${c.endSoc}% | ${c.kwh} kWh | ${c.cost} $ | ${c.km} km (${eff} kWh/100 km)</span>
        ${c.notes ? "<br><span>Notas: " + c.notes + "</span>" : ""}
      `;
      chargesList.appendChild(li);
    });

    const last = charges[charges.length - 1];
    const effLast = last.km && last.kwh
      ? (last.kwh / (last.km / 100)).toFixed(1) + " kWh/100 km"
      : "‚Äì";

    lastChargeText.innerHTML =
      `<strong>${formatDate(last.date)}</strong><br>
       ${last.startSoc}% ‚Üí ${last.endSoc}% | ${last.kwh} kWh | ${last.cost} $ | ${last.km} km<br>
       <span>Consumo: ${effLast}</span>`;

    if (totalKm > 0 && totalKwh > 0) {
      const avgCons = totalKwh / (totalKm / 100);
      statCons.textContent = avgCons.toFixed(1) + " kWh/100 km";

      const avgCostPer100 = (totalCost / totalKm) * 100;
      statCost.textContent = avgCostPer100.toFixed(2) + " $ /100 km";

      const usable = Number(active.usableKwh || 0);
      let range = null;
      if (usable > 0) {
        range = (usable / (avgCons / 100));
        statRange.textContent = range.toFixed(0) + " km";
      } else {
        statRange.textContent = "‚Äì";
      }

      // SOH estimado
      const rated = Number(active.ratedConsumption || 0);
      if (range !== null && rated > 0 && usable > 0) {
        const theoreticalRange = usable / (rated / 100);
        let soh = (range / theoreticalRange) * 100;
        soh = Math.max(50, Math.min(120, soh)); // limitar
        const degr = 100 - soh;
        sohValue.textContent = soh.toFixed(1) + " %";
        degValue.textContent = degr.toFixed(1) + " %";
        const level = Math.max(15, Math.min(100, soh));
        batteryLevelEl.style.width = level + "%";
      } else {
        sohValue.textContent = "‚Äì";
        degValue.textContent = "‚Äì";
        batteryLevelEl.style.width = "50%";
      }
    } else {
      statCons.textContent = "‚Äì";
      statCost.textContent = "‚Äì";
      statRange.textContent = "‚Äì";
      sohValue.textContent = "‚Äì";
      degValue.textContent = "‚Äì";
      batteryLevelEl.style.width = "50%";
    }

    drawChart(dataForChart.reverse());
  }

  chargeForm.addEventListener("submit", e => {
    e.preventDefault();
    const active = getActiveVehicle();
    if (!active) {
      alert("Primero crea un veh√≠culo.");
      return;
    }

    const startSoc = Number(document.getElementById("startSoc").value);
    const endSoc   = Number(document.getElementById("endSoc").value);
    const kwh      = Number(document.getElementById("kwh").value);
    const cost     = Number(document.getElementById("cost").value);
    const km       = Number(document.getElementById("km").value);
    const notes    = document.getElementById("notes").value.trim();

    if (isNaN(startSoc) || isNaN(endSoc) || isNaN(kwh) || isNaN(cost) || isNaN(km)) {
      alert("Revisa los campos num√©ricos.");
      return;
    }

    const id = state.activeVehicleId;
    if (!state.chargesByVehicle[id]) state.chargesByVehicle[id] = [];
    state.chargesByVehicle[id].push({
      date: new Date().toISOString(),
      startSoc, endSoc, kwh, cost, km, notes
    });
    saveState();
    chargeForm.reset();
    renderCharges();
  });

  // Backup
  const exportBtn = document.getElementById("exportBtn");
  const importFile = document.getElementById("importFile");

  exportBtn.addEventListener("click", () => {
    const dataStr = JSON.stringify(state, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ev-logbook-kairos-backup.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  importFile.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        if (!data.vehicles || !data.chargesByVehicle) {
          alert("Archivo inv√°lido.");
          return;
        }
        state = data;
        saveState();
        applyTheme(state.theme || "dark");
        renderVehicleSelect();
        renderVehicleForm();
        renderCharges();
        alert("Backup restaurado.");
      } catch (err) {
        alert("Error al leer el backup.");
      }
    };
    reader.readAsText(file);
  });

  // Imprimir / PDF
  document.getElementById("printBtn").addEventListener("click", () => {
    window.print();
  });

  // Gr√°fico simple en canvas
  function drawChart(values) {
    if (!chartCanvas) return;
    if (!chartCtx) chartCtx = chartCanvas.getContext("2d");
    const ctx = chartCtx;
    const w = chartCanvas.width = chartCanvas.clientWidth;
    const h = chartCanvas.height = chartCanvas.clientHeight;

    ctx.clearRect(0, 0, w, h);

    if (!values || !values.length) {
      ctx.fillStyle = "#666";
      ctx.font = "12px system-ui";
      ctx.fillText("Sin datos suficientes.", 10, h / 2);
      return;
    }

    const maxVal = Math.max(...values);
    const minVal = Math.min(...values);
    const padding = 8;
    const usableW = w - padding * 2;
    const usableH = h - padding * 2;

    ctx.strokeStyle = "rgba(255,255,255,0.2)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padding, h - padding);
    ctx.lineTo(w - padding, h - padding);
    ctx.stroke();

    ctx.strokeStyle = "#2ecc71";
    ctx.lineWidth = 2;
    ctx.beginPath();
    values.forEach((val, i) => {
      const x = padding + (usableW * (i / Math.max(values.length - 1, 1)));
      const norm = (val - minVal) / (maxVal - minVal || 1);
      const y = padding + usableH * (1 - norm);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();
  }

  // INIT
  loadState();
  applyTheme(state.theme || "dark");
  renderVehicleSelect();
  renderVehicleForm();
  renderCharges();
</script>
</body>
</html>

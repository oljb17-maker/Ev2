<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EV Solution ‚Äì Smart EV Analytics</title>
  
  <!-- Metadatos mejorados -->
  <meta name="description" content="EV Solution - Analytics inteligente para veh√≠culos el√©ctricos">
  <meta name="theme-color" content="#0a0e17" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Exo+2:wght@300;400;500;600;700&display=swap');

    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #0f1525;
      --bg-card: rgba(16, 23, 38, 0.8);
      --bg-glass: rgba(255, 255, 255, 0.05);
      --text-primary: #ffffff;
      --text-secondary: #8b9bbd;
      --text-accent: #00f0ff;
      --accent-primary: #00f0ff;
      --accent-secondary: #7b61ff;
      --accent-glow: 0 0 20px rgba(0, 240, 255, 0.5);
      --border-primary: rgba(0, 240, 255, 0.3);
      --border-secondary: rgba(123, 97, 255, 0.3);
      --input-bg: rgba(10, 14, 23, 0.7);
      --success: #00ff9d;
      --warning: #ffb800;
      --danger: #ff2e63;
    }

    body.light {
      --bg-primary: #f0f2f8;
      --bg-secondary: #ffffff;
      --bg-card: rgba(255, 255, 255, 0.9);
      --bg-glass: rgba(255, 255, 255, 0.7);
      --text-primary: #0a0e17;
      --text-secondary: #4a5568;
      --text-accent: #0066cc;
      --accent-primary: #0066cc;
      --accent-secondary: #7b61ff;
      --accent-glow: 0 0 15px rgba(0, 102, 204, 0.3);
      --border-primary: rgba(0, 102, 204, 0.3);
      --border-secondary: rgba(123, 97, 255, 0.3);
      --input-bg: rgba(255, 255, 255, 0.8);
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      background: var(--bg-primary);
      font-family: 'Exo 2', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-primary);
      overflow-x: hidden;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(0, 240, 255, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(123, 97, 255, 0.05) 0%, transparent 20%);
    }

    .app {
      max-width: 520px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 40px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    .app.ready {
      opacity: 1;
    }

    header.app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border-primary);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .app-title-block h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 900;
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: var(--accent-glow);
    }

    .app-title-block small {
      font-size: 12px;
      color: var(--text-secondary);
      letter-spacing: 1px;
      font-weight: 500;
    }

    .header-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .header-select {
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 12px;
      border: 1px solid var(--border-primary);
      background: var(--input-bg);
      color: var(--text-primary);
      font-weight: 500;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .header-select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: var(--accent-glow);
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: none;
      background: var(--bg-glass);
      color: var(--text-primary);
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      border: 1px solid var(--border-primary);
    }

    .icon-btn:hover {
      background: var(--accent-primary);
      color: var(--bg-primary);
      transform: translateY(-2px);
      box-shadow: var(--accent-glow);
    }

    .vehicle-bar {
      margin-top: 16px;
      display: flex;
      gap: 10px;
    }

    .vehicle-bar select {
      flex: 1;
      padding: 12px 16px;
      border-radius: 16px;
      border: 1px solid var(--border-primary);
      background: var(--input-bg);
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .vehicle-bar select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: var(--accent-glow);
    }

    .tabs {
      margin-top: 24px;
      display: flex;
      background: var(--bg-card);
      padding: 6px;
      border-radius: 18px;
      border: 1px solid var(--border-primary);
      backdrop-filter: blur(10px);
    }

    .tab {
      flex: 1;
      padding: 12px 0;
      border-radius: 14px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .tab::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 240, 255, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .tab:hover::before {
      left: 100%;
    }

    .tab.active {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: var(--bg-primary);
      box-shadow: var(--accent-glow);
    }

    .card {
      margin-top: 20px;
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border-primary);
      padding: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
    }

    .card h2 {
      margin: 0 0 16px;
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      font-family: 'Orbitron', sans-serif;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card h2::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 2px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }

    .stat {
      padding: 16px;
      border-radius: 16px;
      border: 1px solid var(--border-primary);
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
    }

    .stat:hover {
      transform: translateY(-5px);
      box-shadow: var(--accent-glow);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      font-family: 'Orbitron', sans-serif;
    }

    .field {
      margin-bottom: 16px;
    }

    .field label {
      display: block;
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .field input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 14px;
      border: 1px solid var(--border-primary);
      background: var(--input-bg);
      color: var(--text-primary);
      font-size: 14px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .field input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: var(--accent-glow);
    }

    .primary {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: none;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: var(--bg-primary);
      font-weight: 700;
      margin-top: 16px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Orbitron', sans-serif;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
    }

    .primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .primary:hover::before {
      left: 100%;
    }

    .primary:hover {
      transform: translateY(-3px);
      box-shadow: var(--accent-glow);
    }

    .secondary-btn {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid var(--border-primary);
      background: transparent;
      color: var(--text-primary);
      margin-top: 12px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }

    .secondary-btn:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      transform: translateY(-2px);
    }

    .secondary-btn.danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    .secondary-btn.danger:hover {
      background: var(--danger);
      color: var(--bg-primary);
    }

    .list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 250px;
      overflow-y: auto;
    }

    .list-item {
      padding: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 14px;
      transition: all 0.3s ease;
      border-radius: 12px;
      margin-bottom: 8px;
      background: var(--bg-glass);
    }

    .list-item:hover {
      background: rgba(0, 240, 255, 0.1);
      transform: translateX(5px);
    }

    .battery-row {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .battery-shell {
      position: relative;
      width: 120px;
      height: 40px;
      border-radius: 10px;
      border: 2px solid var(--border-primary);
      background: rgba(10, 14, 23, 0.8);
      overflow: hidden;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
    }

    .battery-level {
      position: absolute;
      top: 2px;
      left: 2px;
      bottom: 2px;
      width: 40%;
      border-radius: 8px;
      background: linear-gradient(90deg, var(--danger), var(--warning), var(--success));
      transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 0 15px rgba(0, 255, 157, 0.5);
    }

    .battery-tip {
      position: absolute;
      right: -8px;
      top: 12px;
      width: 8px;
      height: 16px;
      border-radius: 4px;
      background: var(--border-primary);
    }

    .chart-wrapper {
      border-radius: 16px;
      border: 1px solid var(--border-primary);
      padding: 16px;
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
    }

    canvas {
      width: 100%;
      height: 140px;
      display: block;
    }

    .hint {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 8px;
      line-height: 1.5;
    }

    .field-hint {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .tab-panel { 
      display: none;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .tab-panel.active { 
      display: block;
    }

    /* SPLASH SCREEN FUTURISTA */
    .splash-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--bg-primary), #0a1120);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: var(--text-primary);
      transition: opacity 0.6s ease, transform 0.6s ease;
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(0, 240, 255, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(123, 97, 255, 0.1) 0%, transparent 40%);
    }

    .splash-screen.hide {
      opacity: 0;
      transform: scale(1.05);
      pointer-events: none;
    }

    .splash-inner { 
      text-align: center;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    .splash-logo {
      font-size: 36px;
      font-weight: 900;
      font-family: 'Orbitron', sans-serif;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 30px rgba(0, 240, 255, 0.7);
      margin-bottom: 10px;
      letter-spacing: 2px;
    }

    .splash-sub {
      font-size: 16px;
      color: var(--text-secondary);
      margin-top: 4px;
      letter-spacing: 3px;
      font-weight: 300;
    }

    .splash-bar {
      width: 200px;
      height: 8px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      overflow: hidden;
      margin: 30px auto 12px;
      border: 1px solid var(--border-primary);
    }

    .splash-bar-fill {
      height: 100%;
      width: 40%;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      animation: splash-loading 1.5s infinite, glow 2s infinite alternate;
    }

    @keyframes splash-loading {
      0% { transform: translateX(-100%); }
      50% { transform: translateX(50%); }
      100% { transform: translateX(200%); }
    }

    @keyframes glow {
      from { box-shadow: 0 0 10px var(--accent-primary); }
      to { box-shadow: 0 0 20px var(--accent-secondary); }
    }

    .splash-tip {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 300;
    }

    /* Efectos de part√≠culas en el fondo */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
    }

    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: var(--accent-primary);
      border-radius: 50%;
      animation: float 15s infinite linear;
    }

    @keyframes float {
      0% {
        transform: translateY(100vh) translateX(0);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) translateX(100px);
        opacity: 0;
      }
    }

    @media print {
      .tabs,
      .header-controls,
      .vehicle-bar,
      #charge-form .primary,
      .secondary-btn,
      #importFile {
        display: none !important;
      }
      body { background: #ffffff; }
      .app {
        max-width: 100%;
        padding: 0;
        opacity: 1 !important;
      }
      .card { 
        border-radius: 0;
        box-shadow: none;
        border: 1px solid #ccc;
      }
    }

    /* Scrollbar personalizado */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, var(--accent-secondary), var(--accent-primary));
    }
  </style>
</head>
<body>

<!-- Part√≠culas de fondo -->
<div class="particles" id="particles"></div>

<!-- SPLASH -->
<div id="splash" class="splash-screen">
  <div class="splash-inner">
    <div class="splash-logo">EV SOLUTION</div>
    <div class="splash-sub">SMART EV ANALYTICS</div>
    <div class="splash-bar">
      <div class="splash-bar-fill"></div>
    </div>
    <div class="splash-tip" id="splashTip">Initializing systems...</div>
  </div>
</div>

<div class="app">
  <header class="app-header">
    <div class="app-title-block">
      <h1 id="t_app_name">EV SOLUTION</h1>
      <small id="t_subtitle">Smart EV Analytics</small>
    </div>
    <div class="header-controls">
      <select id="langSelect" class="header-select" aria-label="Select language">
        <option value="es">ES</option>
        <option value="en">EN</option>
      </select>
      <select id="unitSelect" class="header-select" aria-label="Select unit system">
        <option value="km">KM</option>
        <option value="mi" selected>MI</option>
      </select>
      <button id="themeToggle" class="icon-btn" aria-label="Toggle theme">üåô</button>
    </div>
  </header>

  <div class="vehicle-bar">
    <select id="vehicleSelect" aria-label="Select vehicle"></select>
  </div>

  <nav class="tabs" role="tablist" aria-label="Main sections">
    <button class="tab active" role="tab" aria-selected="true" aria-controls="dashboard" data-tab="dashboard" id="tab_dashboard">
      <span>üìä</span> Dashboard
    </button>
    <button class="tab" role="tab" aria-selected="false" aria-controls="charges" data-tab="charges" id="tab_charges">
      <span>‚ö°</span> Cargas
    </button>
    <button class="tab" role="tab" aria-selected="false" aria-controls="vehicle" data-tab="vehicle" id="tab_vehicle">
      <span>üöó</span> Veh√≠culo
    </button>
  </nav>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="tab-panel active" role="tabpanel" aria-labelledby="tab_dashboard">
      <div class="card">
        <h2>Resumen del Sistema</h2>
        <div class="stats-grid">
          <div class="stat">
            <div class="stat-label" id="t_range_label">Autonom√≠a estimada</div>
            <div class="stat-value" id="stat-range">‚Äì</div>
          </div>
          <div class="stat">
            <div class="stat-label" id="t_cons_label">Consumo medio</div>
            <div class="stat-value" id="stat-consumption">‚Äì</div>
          </div>
          <div class="stat">
            <div class="stat-label" id="t_cost_label">Costo / 100</div>
            <div class="stat-value" id="stat-cost">‚Äì</div>
          </div>
          <div class="stat">
            <div class="stat-label" id="t_charges_label">Cargas registradas</div>
            <div class="stat-value" id="stat-charges">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Estado de Bater√≠a</h2>
        <div class="battery-row">
          <div class="battery-shell">
            <div class="battery-level" id="batteryLevel"></div>
            <div class="battery-tip"></div>
          </div>
          <div style="font-size:14px;">
            <div><span id="t_soh_label">SOH estimado:</span> <strong id="sohValue">‚Äì</strong></div>
            <div><span id="t_deg_label">Degradaci√≥n:</span> <strong id="degValue">‚Äì</strong></div>
          </div>
        </div>
        <p class="hint" id="t_soh_hint">
          Basado en consumo real vs. dato de f√°brica. Es solo una estimaci√≥n aproximada.
        </p>
      </div>

      <div class="card">
        <h2>√öltima Carga</h2>
        <p id="last-charge">Crea un veh√≠culo y registra tu primera carga.</p>
        <button id="printBtn" class="secondary-btn">üìÑ Imprimir / Exportar PDF</button>
      </div>

      <div class="card">
        <h2>An√°lisis de Consumo</h2>
        <div class="chart-wrapper">
          <canvas id="consumptionChart" aria-label="Consumption history chart" role="img"></canvas>
        </div>
        <p class="hint" id="t_chart_hint">
          Consumo (kWh/100 mi) de las √∫ltimas cargas del veh√≠culo seleccionado.
        </p>
      </div>
    </section>

    <!-- CARGAS -->
    <section id="charges" class="tab-panel" role="tabpanel" aria-labelledby="tab_charges">
      <div class="card">
        <h2>Nueva Carga</h2>
        <p class="hint" id="chargeVehicleHint"></p>
        <form id="charge-form" autocomplete="off">
          <div class="field">
            <label for="startSoc" id="t_soc_start_label">% Inicio de Carga</label>
            <input type="number" id="startSoc" name="startSoc" min="0" max="100" required aria-required="true" />
            <div class="field-hint" id="soc_start_help">Porcentaje de bater√≠a al inicio de la carga</div>
          </div>
          <div class="field">
            <label for="endSoc" id="t_soc_end_label">% Final de Carga</label>
            <input type="number" id="endSoc" name="endSoc" min="0" max="100" required aria-required="true" />
            <div class="field-hint" id="soc_end_help">Porcentaje de bater√≠a al final de la carga</div>
          </div>
          <div class="field">
            <label for="kwh" id="t_kwh_label">Energ√≠a Entregada (kWh)</label>
            <input type="number" step="0.01" id="kwh" name="kwh" required aria-required="true" />
            <div class="field-hint" id="kwh_help">Cantidad de energ√≠a suministrada durante la carga</div>
          </div>
          <div class="field">
            <label for="cost" id="t_cost_total_label">Costo Total</label>
            <input type="number" step="0.01" id="cost" name="cost" required aria-required="true" />
            <div class="field-hint" id="cost_help">Costo total de la carga en tu moneda local</div>
          </div>
          <div class="field">
            <label for="distance" id="t_distance_label">Distancia Recorrida (mi)</label>
            <input type="number" step="0.1" id="distance" name="distance" required aria-required="true" />
            <div class="field-hint" id="distance_help">Distancia recorrida desde la √∫ltima carga</div>
          </div>
          <div class="field">
            <label for="notes" id="t_notes_label">Notas (opcional)</label>
            <input type="text" id="notes" name="notes" />
            <div class="field-hint" id="notes_help">Condiciones de conducci√≥n, tipo de cargador, etc.</div>
          </div>
          <button type="submit" class="primary" id="t_save_charge_btn">
            <span>üíæ</span> Guardar Carga
          </button>
        </form>
      </div>

      <div class="card">
        <h2>Historial de Cargas</h2>
        <ul id="charges-list" class="list"></ul>
      </div>
    </section>

    <!-- VEH√çCULO -->
    <section id="vehicle" class="tab-panel" role="tabpanel" aria-labelledby="tab_vehicle">
      <div class="card">
        <h2>Datos del Veh√≠culo</h2>
        <form id="vehicle-form" autocomplete="off">
          <div class="field">
            <label for="alias" id="t_alias_label">Nombre / Alias</label>
            <input type="text" id="alias" name="alias" placeholder="Ioniq 5 SEL AWD" />
          </div>
          <div class="field">
            <label for="brand" id="t_brand_label">Marca</label>
            <input type="text" id="brand" name="brand" />
          </div>
          <div class="field">
            <label for="model" id="t_model_label">Modelo</label>
            <input type="text" id="model" name="model" />
          </div>
          <div class="field">
            <label for="year" id="t_year_label">A√±o</label>
            <input type="number" id="year" name="year" />
          </div>
          <div class="field">
            <label for="usableKwh" id="t_usable_label">Capacidad √ötil (kWh)</label>
            <input type="number" step="0.1" id="usableKwh" name="usableKwh" />
          </div>
          <div class="field">
            <label for="ratedConsumption" id="t_rated_label">Consumo Oficial (kWh/100 km)</label>
            <input type="number" step="0.1" id="ratedConsumption" name="ratedConsumption" />
          </div>
          <button type="submit" class="primary" id="t_save_vehicle_btn">
            <span>üíæ</span> Guardar Veh√≠culo
          </button>
          <button type="button" class="secondary-btn" id="newVehicleInFormBtn">
            <span>üÜï</span> Nuevo Veh√≠culo
          </button>
          <button type="button" class="secondary-btn danger" id="deleteVehicleBtn">
            <span>üóëÔ∏è</span> Eliminar Veh√≠culo
          </button>
        </form>
      </div>

      <div class="card">
        <h2>Copia de Seguridad</h2>
        <button id="exportBtn" class="secondary-btn">
          <span>üì§</span> Exportar Backup (JSON)
        </button>
        <input type="file" id="importFile" accept="application/json" style="margin-top:12px;font-size:12px;width:100%;padding:12px;border-radius:12px;border:1px dashed var(--border-primary);background:var(--bg-glass);color:var(--text-primary);" />
        <p class="hint" id="t_backup_hint">
          Exporta un archivo JSON y gu√°rdalo en la nube. Para restaurar, selecci√≥nalo nuevamente aqu√≠.
        </p>
      </div>
    </section>
  </main>
</div>

<script>
// C√≥digo JavaScript id√©ntico al anterior, solo cambiamos el STORAGE_KEY
const STORAGE_KEY = "ev-solution-v1";
const KM_PER_MI = 1.60934;

let state = {
  theme: "dark",
  lang: "es",
  unit: "mi",
  vehicles: [],
  activeVehicleId: null,
  chargesByVehicle: {}
};

// [El resto del c√≥digo JavaScript permanece exactamente igual]
// Debouncing para guardar estado
let saveTimeout;
function debouncedSaveState() {
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(saveState, 1000);
}

// ------- SEED VEH√çCULOS --------
function seedDefaultVehicles() {
  if (state.vehicles.length) return;

  const defaults = [
    {
      id:"leaf40-2018",
      alias:"Leaf 40 kWh",
      brand:"Nissan",
      model:"Leaf 40 kWh",
      year:"2018-2024",
      usableKwh:"39.0",
      ratedConsumption:"18.0"
    },
    {
      id:"leaf62-2019",
      alias:"Leaf Plus 62 kWh",
      brand:"Nissan",
      model:"Leaf Plus 62 kWh",
      year:"2019-2024",
      usableKwh:"56.0",
      ratedConsumption:"19.0"
    },
    { id:"hyundai-ioniq5-sel-awd-2023", alias:"Ioniq 5 SEL AWD", brand:"Hyundai", model:"Ioniq 5 SEL AWD", year:"2023", usableKwh:"72.6", ratedConsumption:"17.0" },
    { id:"ioniq6-rwd-2024", alias:"Ioniq 6 RWD", brand:"Hyundai", model:"Ioniq 6 Long Range RWD", year:"2024", usableKwh:"72.6", ratedConsumption:"16.0" },
    { id:"ioniq6-awd-2024", alias:"Ioniq 6 AWD", brand:"Hyundai", model:"Ioniq 6 Long Range AWD", year:"2024", usableKwh:"72.6", ratedConsumption:"18.0" },
    { id:"kona-ev-2022", alias:"Kona Electric 64 kWh", brand:"Hyundai", model:"Kona Electric 64 kWh", year:"2022", usableKwh:"64", ratedConsumption:"14.7" },

    // Modelos Kia EV6
    {
      id: "kia-ev6-wind-rwd-new",
      alias: "EV6 Wind RWD",
      brand: "Kia",
      model: "EV6 Wind RWD",
      year: "2023-2024",
      usableKwh: "72.5",
      ratedConsumption: "16.5"
    },
    {
      id: "kia-ev6-wind-awd-new",
      alias: "EV6 Wind AWD",
      brand: "Kia",
      model: "EV6 Wind AWD",
      year: "2023-2024",
      usableKwh: "72.5",
      ratedConsumption: "18.5"
    },
    {
      id: "kia-ev6-gtline-rwd-new",
      alias: "EV6 GT-Line RWD",
      brand: "Kia",
      model: "EV6 GT-Line RWD",
      year: "2022-2024",
      usableKwh: "72.5",
      ratedConsumption: "17.0"
    },
    {
      id: "kia-ev6-gtline-awd-new",
      alias: "EV6 GT-Line AWD",
      brand: "Kia",
      model: "EV6 GT-Line AWD",
      year: "2022-2024",
      usableKwh: "72.5",
      ratedConsumption: "19.0"
    },
    {
      id: "kia-ev6-gt-new",
      alias: "EV6 GT",
      brand: "Kia",
      model: "EV6 GT (AWD Performance)",
      year: "2022-2024",
      usableKwh: "74.0",
      ratedConsumption: "21.0"
    },

    { id:"tesla-m3lr-2023", alias:"Model 3 LR", brand:"Tesla", model:"Model 3 Long Range", year:"2023", usableKwh:"75", ratedConsumption:"15.5" },
    { id:"tesla-my-2023", alias:"Model Y LR", brand:"Tesla", model:"Model Y Long Range", year:"2023", usableKwh:"75", ratedConsumption:"16.9" },
    { id:"cybertruck-awd-2024", alias:"Cybertruck AWD", brand:"Tesla", model:"Cybertruck AWD", year:"2024", usableKwh:"123", ratedConsumption:"24.0" },
    { id:"cybertruck-beast-2024", alias:"Cyberbeast", brand:"Tesla", model:"Cybertruck Cyberbeast", year:"2024", usableKwh:"123", ratedConsumption:"27.0" },
    { id:"rivian-r1t-2023", alias:"R1T Large Pack", brand:"Rivian", model:"R1T", year:"2023", usableKwh:"135", ratedConsumption:"25" },
    { id:"bmw-i4-2023", alias:"i4 eDrive40", brand:"BMW", model:"i4 eDrive40", year:"2023", usableKwh:"80.7", ratedConsumption:"18.0" },
    { id:"merc-eqe-2023", alias:"EQE 350+", brand:"Mercedes-Benz", model:"EQE 350+", year:"2023", usableKwh:"90.6", ratedConsumption:"19.0" },
    { id:"bolt-ev-2017", alias:"Bolt EV", brand:"Chevrolet", model:"Bolt EV", year:"2017-2024", usableKwh:"65", ratedConsumption:"17.0" },
    { id:"bolt-euv-2022", alias:"Bolt EUV", brand:"Chevrolet", model:"Bolt EUV", year:"2022-2024", usableKwh:"65", ratedConsumption:"18.0" },
    { id:"blazer-ev-2024", alias:"Blazer EV", brand:"Chevrolet", model:"Blazer EV", year:"2024", usableKwh:"85", ratedConsumption:"19.0" },
    { id:"equinox-ev-2024", alias:"Equinox EV", brand:"Chevrolet", model:"Equinox EV", year:"2024", usableKwh:"85", ratedConsumption:"17.5" },
    { id:"silverado-ev-2024", alias:"Silverado EV WT", brand:"Chevrolet", model:"Silverado EV (Work Truck)", year:"2024", usableKwh:"200", ratedConsumption:"28.0" },
    { id:"lyriq-rwd-2023", alias:"Lyriq RWD", brand:"Cadillac", model:"Lyriq RWD", year:"2023-2024", usableKwh:"100", ratedConsumption:"18.5" },
    { id:"lyriq-awd-2023", alias:"Lyriq AWD", brand:"Cadillac", model:"Lyriq AWD", year:"2023-2024", usableKwh:"100", ratedConsumption:"19.5" },
    { id:"hummer-pickup-2022", alias:"Hummer EV Pickup", brand:"GMC", model:"Hummer EV Pickup", year:"2022-2024", usableKwh:"212", ratedConsumption:"34.0" },
    { id:"hummer-suv-2023", alias:"Hummer EV SUV", brand:"GMC", model:"Hummer EV SUV", year:"2023-2024", usableKwh:"170", ratedConsumption:"32.0" },
    { id:"bz4x-2023", alias:"Toyota bZ4X", brand:"Toyota", model:"bZ4X FWD", year:"2023-2024", usableKwh:"64", ratedConsumption:"17.9" },
    { id:"solterra-2023", alias:"Solterra AWD", brand:"Subaru", model:"Solterra AWD", year:"2023-2024", usableKwh:"64", ratedConsumption:"19.5" },
    { id:"mache-select-2021", alias:"Mach-E Select", brand:"Ford", model:"Mustang Mach-E Select RWD", year:"2021-2024", usableKwh:"68", ratedConsumption:"17.5" },
    { id:"mache-premium-2021", alias:"Mach-E Premium ER", brand:"Ford", model:"Mustang Mach-E Extended Range", year:"2021-2024", usableKwh:"88", ratedConsumption:"19.0" },
    { id:"f150-sr-2022", alias:"F-150 Lightning SR", brand:"Ford", model:"F-150 Lightning Standard Range", year:"2022-2024", usableKwh:"98", ratedConsumption:"28.0" },
    { id:"f150-er-2022", alias:"F-150 Lightning ER", brand:"Ford", model:"F-150 Lightning Extended Range", year:"2022-2024", usableKwh:"131", ratedConsumption:"30.0" },
    { id:"lucid-pure-2022", alias:"Lucid Air Pure", brand:"Lucid", model:"Air Pure", year:"2022-2024", usableKwh:"88", ratedConsumption:"16.0" },
    { id:"lucid-touring-2022", alias:"Lucid Air Touring", brand:"Lucid", model:"Air Touring", year:"2022-2024", usableKwh:"92", ratedConsumption:"16.5" },
    { id:"lucid-gt-2022", alias:"Lucid Air GT", brand:"Lucid", model:"Air Grand Touring", year:"2022-2024", usableKwh:"118", ratedConsumption:"18.0" }
  ];

  // Verificar IDs √∫nicos
  const ids = new Set();
  const uniqueDefaults = [];
  
  defaults.forEach(vehicle => {
    if (!ids.has(vehicle.id)) {
      ids.add(vehicle.id);
      uniqueDefaults.push(vehicle);
    } else {
      console.warn(`ID duplicado omitido: ${vehicle.id} - ${vehicle.alias}`);
    }
  });

  // Solo asignar si no hay veh√≠culos existentes
  state.vehicles = uniqueDefaults;
  uniqueDefaults.forEach(v => {
    if (!state.chargesByVehicle[v.id]) {
      state.chargesByVehicle[v.id] = [];
    }
  });
  
  if (!state.activeVehicleId && uniqueDefaults.length > 0) {
    state.activeVehicleId = uniqueDefaults[0].id;
  }
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
      const data = JSON.parse(raw);
      state = Object.assign(state, data);
      
      // Migrar datos antiguos si es necesario
      Object.keys(state.chargesByVehicle || {}).forEach(id => {
        state.chargesByVehicle[id] = (state.chargesByVehicle[id] || []).map(c => {
          if (typeof c.kmBase === "number") return c;
          const km = typeof c.km === "number" ? c.km : 0;
          return Object.assign({}, c, { kmBase: km });
        });
      });
    }
    
    // Siempre llamar a seedDefaultVehicles para asegurar que haya veh√≠culos
    seedDefaultVehicles();
    
  } catch(e) { 
    console.warn("Error loading state:", e);
    // En caso de error, asegurarse de que hay veh√≠culos
    seedDefaultVehicles();
  }
}

function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch(e) {
    console.error("Error saving state:", e);
  }
}

function getActiveVehicle() {
  return state.vehicles.find(v => v.id === state.activeVehicleId) || null;
}

function getActiveCharges() {
  return state.chargesByVehicle[state.activeVehicleId] || [];
}

function kmToCurrent(km) {
  return state.unit === "km" ? km : km / KM_PER_MI;
}

function currentToKm(dist) {
  return state.unit === "km" ? dist : dist * KM_PER_MI;
}

function per100kmToUnit(v) {
  return state.unit === "km" ? v : v * KM_PER_MI;
}

function costPer100kmToUnit(v) {
  return state.unit === "km" ? v : v * KM_PER_MI;
}

// ------- I18N --------
const i18n = {
  es: {
    app_name: "EV SOLUTION",
    subtitle: "Smart EV Analytics",
    splash_tip: "Inicializando sistemas...",
    tab_dashboard: "Dashboard",
    tab_charges: "Cargas",
    tab_vehicle: "Veh√≠culo",
    summary_title: "Resumen del Sistema",
    range_label: "Autonom√≠a estimada",
    cons_label_km: "Consumo medio (kWh/100 km)",
    cons_label_mi: "Consumo medio (kWh/100 mi)",
    cost_label_km: "Costo / 100 km",
    cost_label_mi: "Costo / 100 mi",
    charges_label: "Cargas registradas",
    battery_title: "Estado de Bater√≠a",
    soh_label: "SOH estimado:",
    deg_label: "Degradaci√≥n:",
    soh_hint: "Basado en consumo real vs. dato de f√°brica. Es solo una estimaci√≥n aproximada.",
    last_charge_title: "√öltima Carga",
    last_charge_empty: "Crea un veh√≠culo y registra tu primera carga.",
    chart_title: "An√°lisis de Consumo",
    chart_hint_km: "Consumo (kWh/100 km) de las √∫ltimas cargas del veh√≠culo seleccionado.",
    chart_hint_mi: "Consumo (kWh/100 mi) de las √∫ltimas cargas del veh√≠culo seleccionado.",
    new_charge_title: "Nueva Carga",
    save_charge_btn: "Guardar Carga",
    soc_start_label: "% Inicio de Carga",
    soc_end_label: "% Final de Carga",
    kwh_label: "Energ√≠a Entregada (kWh)",
    cost_total_label: "Costo Total",
    distance_label_km: "Distancia Recorrida (km)",
    distance_label_mi: "Distancia Recorrida (mi)",
    notes_label: "Notas (opcional)",
    notes_placeholder: "EA, clima fr√≠o, autopista, etc.",
    history_title: "Historial de Cargas",
    vehicle_data_title: "Datos del Veh√≠culo",
    alias_label: "Nombre / Alias",
    brand_label: "Marca",
    model_label: "Modelo",
    year_label: "A√±o",
    usable_label: "Capacidad √ötil (kWh)",
    rated_label_km: "Consumo Oficial (kWh/100 km)",
    rated_label_mi: "Consumo Oficial (kWh/100 mi)",
    save_vehicle_btn: "Guardar Veh√≠culo",
    new_vehicle_btn: "Nuevo Veh√≠culo",
    delete_vehicle_btn: "Eliminar Veh√≠culo",
    backup_title: "Copia de Seguridad",
    backup_hint: "Exporta un archivo JSON y gu√°rdalo en la nube. Para restaurar, selecci√≥nalo nuevamente aqu√≠.",
    export_backup_btn: "Exportar Backup (JSON)",
    hint_no_vehicle: "Crea tu primer veh√≠culo para empezar a registrar.",
    hint_no_charges: "A√∫n no hay cargas guardadas para este veh√≠culo.",
    hint_create_vehicle_first: "Primero crea un veh√≠culo en la pesta√±a 'Veh√≠culo'.",
    hint_charges_for: name => "Guardando cargas para: " + name,
    print_btn: "Imprimir / Exportar PDF",
    vehicle_select_placeholder: "Selecciona un veh√≠culo",
    alert_vehicle_min: "Coloca al menos un alias o marca/modelo.",
    alert_vehicle_saved: "Veh√≠culo guardado.",
    alert_vehicle_deleted: "Veh√≠culo eliminado.",
    alert_check_numbers: "Revisa los campos num√©ricos.",
    alert_create_vehicle_first: "Primero crea un veh√≠culo.",
    alert_backup_invalid: "Archivo de backup inv√°lido.",
    alert_backup_error: "Error al leer el backup.",
    alert_backup_restored: "Backup restaurado.",
    alert_soc_invalid: "El porcentaje final debe ser mayor al inicial.",
    alert_min_charge: "La carga debe ser de al menos 5% para ser significativa."
  },
  en: {
    app_name: "EV SOLUTION",
    subtitle: "Smart EV Analytics",
    splash_tip: "Initializing systems...",
    tab_dashboard: "Dashboard",
    tab_charges: "Charges",
    tab_vehicle: "Vehicle",
    summary_title: "System Summary",
    range_label: "Estimated range",
    cons_label_km: "Average consumption (kWh/100 km)",
    cons_label_mi: "Average consumption (kWh/100 mi)",
    cost_label_km: "Cost / 100 km",
    cost_label_mi: "Cost / 100 mi",
    charges_label: "Logged charges",
    battery_title: "Battery Status",
    soh_label: "Estimated SOH:",
    deg_label: "Degradation:",
    soh_hint: "Based on real consumption vs rated value. Only an approximate estimate.",
    last_charge_title: "Last Charge",
    last_charge_empty: "Create a vehicle and log your first charge.",
    chart_title: "Consumption Analysis",
    chart_hint_km: "Consumption (kWh/100 km) for the last charges of the selected vehicle.",
    chart_hint_mi: "Consumption (kWh/100 mi) for the last charges of the selected vehicle.",
    new_charge_title: "New Charge",
    save_charge_btn: "Save Charge",
    soc_start_label: "% Start Charge",
    soc_end_label: "% End Charge",
    kwh_label: "Delivered Energy (kWh)",
    cost_total_label: "Total Cost",
    distance_label_km: "Distance Traveled (km)",
    distance_label_mi: "Distance Traveled (mi)",
    notes_label: "Notes (optional)",
    notes_placeholder: "EA, cold weather, highway, etc.",
    history_title: "Charge History",
    vehicle_data_title: "Vehicle Data",
    alias_label: "Name / Alias",
    brand_label: "Brand",
    model_label: "Model",
    year_label: "Year",
    usable_label: "Usable Capacity (kWh)",
    rated_label_km: "Official Consumption (kWh/100 km)",
    rated_label_mi: "Official Consumption (kWh/100 mi)",
    save_vehicle_btn: "Save Vehicle",
    new_vehicle_btn: "New Vehicle",
    delete_vehicle_btn: "Delete Vehicle",
    backup_title: "Backup",
    backup_hint: "Export a JSON file and store it safely. To restore, select it again here.",
    export_backup_btn: "Export Backup (JSON)",
    hint_no_vehicle: "Create your first vehicle to start logging.",
    hint_no_charges: "No charges saved yet for this vehicle.",
    hint_create_vehicle_first: "Create a vehicle in the 'Vehicle' tab first.",
    hint_charges_for: name => "Logging charges for: " + name,
    print_btn: "Print / Export PDF",
    vehicle_select_placeholder: "Select a vehicle",
    alert_vehicle_min: "Enter at least an alias or brand/model.",
    alert_vehicle_saved: "Vehicle saved.",
    alert_vehicle_deleted: "Vehicle deleted.",
    alert_check_numbers: "Please check the numeric fields.",
    alert_create_vehicle_first: "Create a vehicle first.",
    alert_backup_invalid: "Invalid backup file.",
    alert_backup_error: "Error reading backup file.",
    alert_backup_restored: "Backup restored.",
    alert_soc_invalid: "End percentage must be higher than start.",
    alert_min_charge: "Charge must be at least 5% to be significant."
  }
};

function t(key, ...args) {
  const pack = i18n[state.lang] || i18n.es;
  const val = pack[key];
  if (typeof val === "function") return val.apply(null,args);
  return (val !== undefined && val !== null) ? val : key;
}

// ------- DOM --------
const langSelect = document.getElementById("langSelect");
const unitSelect = document.getElementById("unitSelect");
const themeToggle = document.getElementById("themeToggle");
const vehicleSelect = document.getElementById("vehicleSelect");
const tabButtons = document.querySelectorAll(".tab");
const panels = document.querySelectorAll(".tab-panel");
const statRange = document.getElementById("stat-range");
const statCons = document.getElementById("stat-consumption");
const statCost = document.getElementById("stat-cost");
const statCharges = document.getElementById("stat-charges");
const lastChargeText = document.getElementById("last-charge");
const batteryLevelEl = document.getElementById("batteryLevel");
const sohValue = document.getElementById("sohValue");
const degValue = document.getElementById("degValue");
const chartCanvas = document.getElementById("consumptionChart");
const chargeForm = document.getElementById("charge-form");
const chargesList = document.getElementById("charges-list");
const chargeVehicleHint = document.getElementById("chargeVehicleHint");
const vehicleForm = document.getElementById("vehicle-form");
const newVehicleInFormBtn = document.getElementById("newVehicleInFormBtn");
const deleteVehicleBtn = document.getElementById("deleteVehicleBtn");
const exportBtn = document.getElementById("exportBtn");
const importFile = document.getElementById("importFile");
const printBtn = document.getElementById("printBtn");
const splashTip = document.getElementById("splashTip");

function applyTheme(theme) {
  state.theme = theme;
  if (theme === "light") {
    document.body.classList.add("light");
    themeToggle.textContent = "üåô";
    themeToggle.setAttribute("aria-label", "Switch to dark mode");
  } else {
    document.body.classList.remove("light");
    themeToggle.textContent = "‚òÄÔ∏è";
    themeToggle.setAttribute("aria-label", "Switch to light mode");
  }
}

function applyTranslations() {
  document.getElementById("t_app_name").textContent = t("app_name");
  document.getElementById("t_subtitle").textContent = t("subtitle");
  splashTip.textContent = t("splash_tip");
  document.getElementById("tab_dashboard").textContent = t("tab_dashboard");
  document.getElementById("tab_charges").textContent = t("tab_charges");
  document.getElementById("tab_vehicle").textContent = t("tab_vehicle");
  document.getElementById("t_summary_title").textContent = t("summary_title");
  document.getElementById("t_range_label").textContent = t("range_label");
  document.getElementById("t_cons_label").textContent =
    state.unit === "km" ? t("cons_label_km") : t("cons_label_mi");
  document.getElementById("t_cost_label").textContent =
    state.unit === "km" ? t("cost_label_km") : t("cost_label_mi");
  document.getElementById("t_charges_label").textContent = t("charges_label");
  document.getElementById("t_battery_title").textContent = t("battery_title");
  document.getElementById("t_soh_label").textContent = t("soh_label");
  document.getElementById("t_deg_label").textContent = t("deg_label");
  document.getElementById("t_soh_hint").textContent = t("soh_hint");
  document.getElementById("t_last_charge_title").textContent = t("last_charge_title");
  printBtn.textContent = t("print_btn");
  document.getElementById("t_chart_title").textContent = t("chart_title");
  document.getElementById("t_chart_hint").textContent =
    state.unit === "km" ? t("chart_hint_km") : t("chart_hint_mi");
  document.getElementById("t_new_charge_title").textContent = t("new_charge_title");
  document.getElementById("t_soc_start_label").textContent = t("soc_start_label");
  document.getElementById("t_soc_end_label").textContent = t("soc_end_label");
  document.getElementById("t_kwh_label").textContent = t("kwh_label");
  document.getElementById("t_cost_total_label").textContent = t("cost_total_label");
  document.getElementById("t_distance_label").textContent =
    state.unit === "km" ? t("distance_label_km") : t("distance_label_mi");
  document.getElementById("t_notes_label").textContent = t("notes_label");
  document.getElementById("notes").placeholder = t("notes_placeholder");
  document.getElementById("t_save_charge_btn").textContent = t("save_charge_btn");
  document.getElementById("t_history_title").textContent = t("history_title");
  document.getElementById("t_vehicle_data_title").textContent = t("vehicle_data_title");
  document.getElementById("t_alias_label").textContent = t("alias_label");
  document.getElementById("t_brand_label").textContent = t("brand_label");
  document.getElementById("t_model_label").textContent = t("model_label");
  document.getElementById("t_year_label").textContent = t("year_label");
  document.getElementById("t_usable_label").textContent = t("usable_label");
  document.getElementById("t_rated_label").textContent =
    state.unit === "km" ? t("rated_label_km") : t("rated_label_mi");
  document.getElementById("t_save_vehicle_btn").textContent = t("save_vehicle_btn");
  newVehicleInFormBtn.textContent = t("new_vehicle_btn");
  deleteVehicleBtn.textContent = t("delete_vehicle_btn");
  document.getElementById("t_backup_title").textContent = t("backup_title");
  document.getElementById("t_backup_hint").textContent = t("backup_hint");
  exportBtn.textContent = t("export_backup_btn");
}

function renderVehicleSelect() {
  vehicleSelect.innerHTML = "";
  if (!state.vehicles.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = t("vehicle_select_placeholder");
    vehicleSelect.appendChild(opt);
    vehicleSelect.disabled = true;
    return;
  }
  vehicleSelect.disabled = false;
  state.vehicles.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.id;
    opt.textContent = v.alias || (v.brand + " " + v.model) || "EV";
    vehicleSelect.appendChild(opt);
  });
  if (!state.activeVehicleId && state.vehicles.length > 0) {
    state.activeVehicleId = state.vehicles[0].id;
  }
  if (state.activeVehicleId) {
    vehicleSelect.value = state.activeVehicleId;
  }
}

function renderVehicleForm() {
  const v = getActiveVehicle();
  if (v) {
    vehicleForm.alias.value = v.alias || "";
    vehicleForm.brand.value = v.brand || "";
    vehicleForm.model.value = v.model || "";
    vehicleForm.year.value = v.year || "";
    vehicleForm.usableKwh.value = v.usableKwh || "";
    vehicleForm.ratedConsumption.value = v.ratedConsumption || "";
    deleteVehicleBtn.disabled = false;
  } else {
    vehicleForm.reset();
    deleteVehicleBtn.disabled = true;
  }
}

function updateChargeFormAvailability() {
  const v = getActiveVehicle();
  const inputs = chargeForm.querySelectorAll("input, button");
  if (!v) {
    inputs.forEach(el => el.disabled = true);
    chargeVehicleHint.textContent = t("hint_create_vehicle_first");
  } else {
    inputs.forEach(el => el.disabled = false);
    const name = v.alias || (v.brand + " " + v.model) || "EV";
    chargeVehicleHint.textContent = t("hint_charges_for", name);
  }
}

let chartCtx = null;
let chartData = [];
function drawChart(values) {
  if (!chartCanvas) return;
  if (!chartCtx) chartCtx = chartCanvas.getContext("2d");
  const w = chartCanvas.width = chartCanvas.clientWidth || 300;
  const h = chartCanvas.height = chartCanvas.clientHeight || 120;
  const ctx = chartCtx;
  ctx.clearRect(0,0,w,h);
  if (!values || !values.length) {
    ctx.fillStyle = "#888";
    ctx.font = "12px system-ui";
    ctx.fillText(state.lang === "es" ? "Sin datos suficientes." : "Not enough data.", 10, h/2);
    return;
  }
  const maxVal = Math.max.apply(null, values);
  const minVal = Math.min.apply(null, values);
  const pad = 8;
  const uw = w - pad*2;
  const uh = h - pad*2;
  ctx.strokeStyle = "rgba(255,255,255,0.3)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad, h-pad);
  ctx.lineTo(w-pad, h-pad);
  ctx.stroke();
  ctx.strokeStyle = "#2ecc71";
  ctx.lineWidth = 2;
  ctx.beginPath();
  for (let i=0;i<values.length;i++) {
    const v = values[i];
    const x = pad + uw * (i/Math.max(values.length-1,1));
    const norm = (v - minVal) / (maxVal - minVal || 1);
    const y = pad + uh * (1-norm);
    if (i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();
}

function updateChartData(newData) {
  chartData = newData;
  drawChart(chartData);
}

function formatDate(d) {
  return new Date(d).toLocaleString();
}

function renderChargesAndStats() {
  updateChargeFormAvailability();
  const v = getActiveVehicle();
  chargesList.innerHTML = "";
  if (!v) {
    chargesList.innerHTML = "<li class='list-item'>" + t("hint_no_vehicle") + "</li>";
    lastChargeText.textContent = t("last_charge_empty");
    statRange.textContent = "‚Äì";
    statCons.textContent = "‚Äì";
    statCost.textContent = "‚Äì";
    statCharges.textContent = "0";
    sohValue.textContent = "‚Äì";
    degValue.textContent = "‚Äì";
    batteryLevelEl.style.width = "30%";
    updateChartData([]);
    return;
  }
  const charges = getActiveCharges();
  if (!charges.length) {
    chargesList.innerHTML = "<li class='list-item'>" + t("hint_no_charges") + "</li>";
    lastChargeText.textContent = t("hint_no_charges");
    statRange.textContent = "‚Äì";
    statCons.textContent = "‚Äì";
    statCost.textContent = "‚Äì";
    statCharges.textContent = "0";
    sohValue.textContent = "‚Äì";
    degValue.textContent = "‚Äì";
    batteryLevelEl.style.width = "45%";
    updateChartData([]);
    return;
  }

  statCharges.textContent = String(charges.length);
  let totalKmBase = 0;
  let totalKwh = 0;
  let totalCost = 0;
  const chartVals = [];

  charges.slice().reverse().forEach(c => {
    totalKmBase += c.kmBase;
    totalKwh += c.kwh;
    totalCost += c.cost;
    const consPer100km = c.kmBase > 0 ? c.kwh / (c.kmBase/100) : 0;
    const consUnit = per100kmToUnit(consPer100km);
    chartVals.push(consUnit);
    const distShown = kmToCurrent(c.kmBase).toFixed(1);
    const unitTxt = state.unit;
    const effTxt = c.kmBase>0 ? consUnit.toFixed(1) + " kWh/100 " + unitTxt : "‚Äì";
    const li = document.createElement("li");
    li.className = "list-item";
    li.innerHTML =
      "<strong>"+formatDate(c.date)+"</strong><br>" +
      "<span>" +
      c.startSoc + "% ‚Üí " + c.endSoc + "% | " +
      c.kwh + " kWh | " +
      c.cost + " $ | " +
      distShown + " " + unitTxt +
      " (" + effTxt + ")" +
      "</span>" +
      (c.notes ? "<br><span>" + c.notes + "</span>" : "");
    chargesList.appendChild(li);
  });

  const last = charges[charges.length-1];
  const lastConsPer100km = last.kmBase>0 ? last.kwh / (last.kmBase/100) : 0;
  const lastConsUnit = per100kmToUnit(lastConsPer100km);
  const lastDistShown = kmToCurrent(last.kmBase).toFixed(1);
  const unitTxt = state.unit;
  lastChargeText.innerHTML =
    "<strong>"+formatDate(last.date)+"</strong><br>" +
    last.startSoc + "% ‚Üí " + last.endSoc + "% | " +
    last.kwh + " kWh | " +
    last.cost + " $ | " +
    lastDistShown + " " + unitTxt + "<br>" +
    "<span>" + lastConsUnit.toFixed(1) + " kWh/100 " + unitTxt + "</span>";

  if (totalKmBase>0 && totalKwh>0) {
    const avgPer100km = totalKwh / (totalKmBase/100);
    const avgUnit = per100kmToUnit(avgPer100km);
    statCons.textContent = avgUnit.toFixed(1) + " kWh/100 " + unitTxt;

    const costPerKm = totalCost / totalKmBase;
    const baseCost100 = costPerKm*100;
    const costUnit = costPer100kmToUnit(baseCost100);
    statCost.textContent = costUnit.toFixed(2) + " $ / 100 " + unitTxt;

    const usable = parseFloat(v.usableKwh || "0");
    if (usable>0 && avgPer100km>0) {
      const rangeKm = usable / (avgPer100km/100);
      const rangeShown = kmToCurrent(rangeKm);
      statRange.textContent = rangeShown.toFixed(0) + " " + unitTxt;

      const rated = parseFloat(v.ratedConsumption || "0");
      if (rated>0) {
        const theoKm = usable / (rated/100);
        let soh = (rangeKm / theoKm)*100;
        soh = Math.max(50, Math.min(120, soh));
        const degr = 100 - soh;
        sohValue.textContent = soh.toFixed(1) + " %";
        degValue.textContent = degr.toFixed(1) + " %";
        const width = Math.max(15, Math.min(100, soh));
        batteryLevelEl.style.width = width + "%";
      } else {
        sohValue.textContent = "‚Äì";
        degValue.textContent = "‚Äì";
        batteryLevelEl.style.width = "50%";
      }
    } else {
      statRange.textContent = "‚Äì";
      sohValue.textContent = "‚Äì";
      degValue.textContent = "‚Äì";
      batteryLevelEl.style.width = "50%";
    }
  } else {
    statRange.textContent = "‚Äì";
    statCons.textContent = "‚Äì";
    statCost.textContent = "‚Äì";
    sohValue.textContent = "‚Äì";
    degValue.textContent = "‚Äì";
    batteryLevelEl.style.width = "50%";
  }

  updateChartData(chartVals.reverse());
}

// ------- EVENTOS UI --------
tabButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    tabButtons.forEach(b => {
      b.classList.remove("active");
      b.setAttribute("aria-selected", "false");
    });
    panels.forEach(p => p.classList.remove("active"));
    btn.classList.add("active");
    btn.setAttribute("aria-selected", "true");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

langSelect.addEventListener("change", () => {
  state.lang = langSelect.value;
  debouncedSaveState();
  applyTranslations();
  renderVehicleSelect();
  renderVehicleForm();
  renderChargesAndStats();
});

unitSelect.addEventListener("change", () => {
  state.unit = unitSelect.value;
  debouncedSaveState();
  applyTranslations();
  renderChargesAndStats();
});

themeToggle.addEventListener("click", () => {
  state.theme = state.theme === "dark" ? "light" : "dark";
  applyTheme(state.theme);
  debouncedSaveState();
});

vehicleSelect.addEventListener("change", () => {
  state.activeVehicleId = vehicleSelect.value || null;
  debouncedSaveState();
  renderVehicleForm();
  renderChargesAndStats();
});

newVehicleInFormBtn.addEventListener("click", () => {
  state.activeVehicleId = null;
  vehicleForm.reset();
  renderVehicleForm();
  renderChargesAndStats();
});

deleteVehicleBtn.addEventListener("click", () => {
  const v = getActiveVehicle();
  if (!v) return;
  const name = v.alias || (v.brand + " " + v.model) || "EV";
  const msg = state.lang === "es"
    ? `¬øSeguro que deseas eliminar el veh√≠culo "${name}" y todas sus cargas?`
    : `Are you sure you want to delete vehicle "${name}" and all its charges?`;
  if (!confirm(msg)) return;

  const idx = state.vehicles.findIndex(x => x.id === v.id);
  if (idx >= 0) {
    state.vehicles.splice(idx,1);
    delete state.chargesByVehicle[v.id];
  }
  if (state.vehicles.length) {
    state.activeVehicleId = state.vehicles[0].id;
  } else {
    state.activeVehicleId = null;
  }
  debouncedSaveState();
  renderVehicleSelect();
  renderVehicleForm();
  renderChargesAndStats();
  alert(t("alert_vehicle_deleted"));
});

vehicleForm.addEventListener("submit", e => {
  e.preventDefault();
  const alias = vehicleForm.alias.value.trim();
  const brand = vehicleForm.brand.value.trim();
  const model = vehicleForm.model.value.trim();
  const year = vehicleForm.year.value.trim();
  const usableKwh = vehicleForm.usableKwh.value.trim();
  const ratedConsumption = vehicleForm.ratedConsumption.value.trim();

  if (!alias && !brand && !model) {
    alert(t("alert_vehicle_min"));
    return;
  }

  if (!state.activeVehicleId) {
    const id = "veh-" + Date.now().toString(36);
    const v = { id, alias, brand, model, year, usableKwh, ratedConsumption };
    state.vehicles.push(v);
    state.activeVehicleId = id;
    state.chargesByVehicle[id] = [];
  } else {
    const idx = state.vehicles.findIndex(v => v.id === state.activeVehicleId);
    if (idx>=0) {
      state.vehicles[idx] = Object.assign({}, state.vehicles[idx], {
        alias, brand, model, year, usableKwh, ratedConsumption
      });
    }
  }
  debouncedSaveState();
  renderVehicleSelect();
  renderVehicleForm();
  renderChargesAndStats();
  alert(t("alert_vehicle_saved"));
});

chargeForm.addEventListener("submit", e => {
  e.preventDefault();
  const v = getActiveVehicle();
  if (!v) { alert(t("alert_create_vehicle_first")); return; }
  const startSoc = parseFloat(document.getElementById("startSoc").value);
  const endSoc = parseFloat(document.getElementById("endSoc").value);
  const kwh = parseFloat(document.getElementById("kwh").value);
  const cost = parseFloat(document.getElementById("cost").value);
  const dist = parseFloat(document.getElementById("distance").value);
  const notes = document.getElementById("notes").value.trim();
  
  // Validaci√≥n mejorada
  if ([startSoc,endSoc,kwh,cost,dist].some(function(v){ return isNaN(v); })) {
    alert(t("alert_check_numbers"));
    return;
  }
  
  if (startSoc >= endSoc) {
    alert(t("alert_soc_invalid"));
    return;
  }
  
  if (endSoc - startSoc < 5) {
    alert(t("alert_min_charge"));
    return;
  }
  
  const kmBase = currentToKm(dist);
  const vid = state.activeVehicleId;
  if (!state.chargesByVehicle[vid]) state.chargesByVehicle[vid] = [];
  state.chargesByVehicle[vid].push({
    date: new Date().toISOString(),
    startSoc: startSoc,
    endSoc: endSoc,
    kwh: kwh,
    cost: cost,
    kmBase: kmBase,
    notes: notes
  });
  debouncedSaveState();
  chargeForm.reset();
  renderChargesAndStats();
});

exportBtn.addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ev-solution-backup.json";
  a.click();
  URL.revokeObjectURL(url);
});

importFile.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (!data.vehicles || !data.chargesByVehicle) {
        alert(t("alert_backup_invalid"));
        return;
      }
      state = Object.assign(state, data);
      debouncedSaveState();
      applyTheme(state.theme || "dark");
      langSelect.value = state.lang || "es";
      unitSelect.value = state.unit || "mi";
      applyTranslations();
      renderVehicleSelect();
      renderVehicleForm();
      renderChargesAndStats();
      alert(t("alert_backup_restored"));
    } catch(err) {
      console.error("Backup error:", err);
      alert(t("alert_backup_error"));
    }
  };
  reader.readAsText(file);
});

printBtn.addEventListener("click", () => window.print());

// ------- PART√çCULAS DE FONDO --------
function createParticles() {
  const particlesContainer = document.getElementById('particles');
  const particleCount = 50;
  
  for (let i = 0; i < particleCount; i++) {
    const particle = document.createElement('div');
    particle.classList.add('particle');
    
    // Posici√≥n aleatoria
    const left = Math.random() * 100;
    const top = Math.random() * 100;
    
    // Tama√±o aleatorio
    const size = Math.random() * 3 + 1;
    
    // Duraci√≥n de animaci√≥n aleatoria
    const duration = Math.random() * 20 + 10;
    const delay = Math.random() * 20;
    
    particle.style.left = `${left}%`;
    particle.style.top = `${top}%`;
    particle.style.width = `${size}px`;
    particle.style.height = `${size}px`;
    particle.style.animationDuration = `${duration}s`;
    particle.style.animationDelay = `${delay}s`;
    
    particlesContainer.appendChild(particle);
  }
}

// ------- INIT --------
loadState();
applyTheme(state.theme || "dark");
langSelect.value = state.lang || "es";
unitSelect.value = state.unit || "mi";
applyTranslations();
renderVehicleSelect();
renderVehicleForm();
renderChargesAndStats();
createParticles();

// ------- SPLASH --------
const splashEl = document.getElementById("splash");
const appRoot = document.querySelector(".app");
setTimeout(() => {
  if (splashEl) {
    splashEl.classList.add("hide");
    setTimeout(() => {
      splashEl.style.display = "none";
    }, 600);
  }
  if (appRoot) {
    appRoot.classList.add("ready");
  }
}, 1500);

// ------- SERVICE WORKER --------
if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    try {
      const registration = await navigator.serviceWorker.register("./service-worker.js");
      console.log("Service Worker registered: ", registration);
    } catch (error) {
      console.log("Service Worker registration failed: ", error);
    }
  });
}
</script>
</body>
</html>
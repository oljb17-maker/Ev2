<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EV Logbook â€“ Kairos Edition</title>

  <!-- PWA -->
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    :root {
      --bg: radial-gradient(circle at top, #283341 0%, #05070b 80%);
      --card: #111a22;
      --text: #f3f6fc;
      --text2: #8e9aac;
      --accent: #2ecc71;
      --accent-soft: rgba(46, 204, 113, 0.18);
      --border: #1c232e;
      --input: #10161d;
    }
    body.light {
      --bg: radial-gradient(circle at top, #f3f5fa 0%, #dde3ef 80%);
      --card: #ffffff;
      --text: #0c0e10;
      --text2: #596579;
      --accent: #2ecc71;
      --accent-soft: rgba(46, 204, 113, 0.16);
      --border: #cfd7e4;
      --input: #f1f4fa;
    }
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      background: var(--bg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text);
    }
    .app {
      max-width: 520px;
      margin: 0 auto;
      padding: 14px;
      padding-bottom: 40px;
      opacity: 0;
      transition: opacity 0.35s ease;
    }
    .app.ready {
      opacity: 1;
    }
    header.app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .app-title-block h1 {
      margin: 0;
      font-size: 22px;
    }
    .app-title-block small {
      font-size: 12px;
      color: var(--text2);
    }
    .header-controls {
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .header-select {
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
    }
    .icon-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(255,255,255,0.08);
      color: var(--text);
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .vehicle-bar {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }
    .vehicle-bar select {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
      font-size: 13px;
    }
    .tabs {
      margin-top: 14px;
      display: flex;
      background: rgba(0,0,0,0.3);
      padding: 3px;
      border-radius: 999px;
    }
    .tab {
      flex: 1;
      padding: 8px 0;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: var(--text2);
      font-size: 13px;
    }
    .tab.active {
      background: var(--accent-soft);
      color: var(--accent);
    }
    .card {
      margin-top: 14px;
      background: var(--card);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 12px;
    }
    .card h2 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
    }
    .stat {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.25);
    }
    .stat-label {
      font-size: 12px;
      color: var(--text2);
    }
    .stat-value {
      font-size: 16px;
      font-weight: 600;
    }
    .field {
      margin-bottom: 8px;
    }
    .field label {
      display: block;
      font-size: 12px;
      color: var(--text2);
      margin-bottom: 3px;
    }
    .field input {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
      font-size: 13px;
    }
    .primary {
      width: 100%;
      padding: 9px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #041006;
      font-weight: 600;
      margin-top: 10px;
      font-size: 14px;
    }
    .secondary-btn {
      width: 100%;
      padding: 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      margin-top: 6px;
      font-size: 13px;
    }
    .list {
      list-style: none;
      padding: 0;
      margin: 0;
      max-height: 250px;
      overflow-y: auto;
    }
    .list-item {
      padding: 6px 2px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      font-size: 12px;
    }
    .battery-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .battery-shell {
      position: relative;
      width: 90px;
      height: 32px;
      border-radius: 6px;
      border: 2px solid var(--border);
      background: #050910;
    }
    .battery-level {
      position: absolute;
      top: 2px;
      left: 2px;
      bottom: 2px;
      width: 40%;
      border-radius: 4px;
      background: linear-gradient(90deg,#e74c3c,#f1c40f,#2ecc71);
      transition: width 0.6s ease-out;
    }
    .battery-tip {
      position: absolute;
      right: -7px;
      top: 7px;
      width: 6px;
      height: 16px;
      border-radius: 4px;
      background: var(--border);
    }
    .chart-wrapper {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 8px;
      background: rgba(0,0,0,0.2);
    }
    canvas {
      width: 100%;
      height: 120px;
      display: block;
    }
    .hint {
      font-size: 11px;
      color: var(--text2);
      margin-top: 4px;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* SPLASH */
    .splash-screen {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #1f2937 0%, #020617 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: #e5e7eb;
      transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .splash-screen.hide {
      opacity: 0;
      transform: scale(0.98);
      pointer-events: none;
    }
    .splash-inner { text-align: center; }
    .splash-logo {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.08em;
    }
    .splash-sub {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .splash-bar {
      width: 160px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148,163,184,0.25);
      overflow: hidden;
      margin: 18px auto 8px;
    }
    .splash-bar-fill {
      height: 100%;
      width: 40%;
      border-radius: 999px;
      background: linear-gradient(90deg,#22c55e,#a3e635);
      animation: splash-loading 1.2s infinite;
    }
    .splash-tip {
      font-size: 11px;
      color: #9ca3af;
    }
    @keyframes splash-loading {
      0%   { transform: translateX(-80%); }
      50%  { transform: translateX(10%); }
      100% { transform: translateX(120%); }
    }

    @media print {
      .tabs,
      .header-controls,
      .vehicle-bar,
      #charge-form .primary,
      .secondary-btn,
      #importFile {
        display: none !important;
      }
      body { background: #ffffff; }
      .app {
        max-width: 100%;
        padding: 0;
        opacity: 1 !important;
      }
      .card { border-radius: 0; }
    }
  </style>
</head>
<body>

<!-- SPLASH -->
<div id="splash" class="splash-screen">
  <div class="splash-inner">
    <div class="splash-logo">EV LOGBOOK</div>
    <div class="splash-sub">Kairos Edition</div>
    <div class="splash-bar">
      <div class="splash-bar-fill"></div>
    </div>
    <div class="splash-tip" id="splashTip">Loading battery dataâ€¦</div>
  </div>
</div>

<div class="app">
  <header class="app-header">
    <div class="app-title-block">
      <h1 id="t_app_name">EV Logbook</h1>
      <small id="t_subtitle">Kairos Edition</small>
    </div>
    <div class="header-controls">
      <select id="langSelect" class="header-select">
        <option value="es">ES</option>
        <option value="en">EN</option>
      </select>
      <select id="unitSelect" class="header-select">
        <option value="km">KM</option>
        <option value="mi" selected>MI</option>
      </select>
      <button id="themeToggle" class="icon-btn">ðŸŒ™</button>
    </div>
  </header>

  <div class="vehicle-bar">
    <select id="vehicleSelect"></select>
  </div>

  <nav class="tabs">
    <button class="tab active" data-tab="dashboard" id="tab_dashboard">Dashboard</button>
    <button class="tab" data-tab="charges" id="tab_charges">Cargas</button>
    <button class="tab" data-tab="vehicle" id="tab_vehicle">VehÃ­culo</button>
  </nav>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="tab-panel active">
      <div class="card">
        <h2 id="t_summary_title">Resumen</h2>
        <div class="stats-grid">
          <div class="stat">
            <div class="stat-label" id="t_range_label">AutonomÃ­a estimada</div>
            <div class="stat-value" id="stat-range">â€“</div>
          </div>
          <div class="stat">
            <div class="stat-label" id="t_cons_label">Consumo medio</div>
            <div class="stat-value" id="stat-consumption">â€“</div>
          </div>
          <div class="stat">
            <div class="stat-label" id="t_cost_label">Costo / 100</div>
            <div class="stat-value" id="stat-cost">â€“</div>
          </div>
          <div class="stat">
            <div class="stat-label" id="t_charges_label">Cargas registradas</div>
            <div class="stat-value" id="stat-charges">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2 id="t_battery_title">BaterÃ­a / SOH</h2>
        <div class="battery-row">
          <div class="battery-shell">
            <div class="battery-level" id="batteryLevel"></div>
            <div class="battery-tip"></div>
          </div>
          <div style="font-size:12px;">
            <div><span id="t_soh_label">SOH estimado:</span> <strong id="sohValue">â€“</strong></div>
            <div><span id="t_deg_label">DegradaciÃ³n:</span> <strong id="degValue">â€“</strong></div>
          </div>
        </div>
        <p class="hint" id="t_soh_hint">
          Basado en consumo real vs. dato de fÃ¡brica. Es solo una estimaciÃ³n aproximada.
        </p>
      </div>

      <div class="card">
        <h2 id="t_last_charge_title">Ãšltima carga</h2>
        <p id="last-charge">Crea un vehÃ­culo y registra tu primera carga.</p>
        <button id="printBtn" class="secondary-btn">Imprimir / Exportar PDF</button>
      </div>

      <div class="card">
        <h2 id="t_chart_title">Historial visual</h2>
        <div class="chart-wrapper">
          <canvas id="consumptionChart"></canvas>
        </div>
        <p class="hint" id="t_chart_hint">
          Consumo (kWh/100 mi) de las Ãºltimas cargas del vehÃ­culo seleccionado.
        </p>
      </div>
    </section>

    <!-- CARGAS -->
    <section id="charges" class="tab-panel">
      <div class="card">
        <h2 id="t_new_charge_title">Nueva carga</h2>
        <p class="hint" id="chargeVehicleHint"></p>
        <form id="charge-form" autocomplete="off">
          <div class="field">
            <label id="t_soc_start_label">% inicio</label>
            <input type="number" id="startSoc" min="0" max="100" required />
          </div>
          <div class="field">
            <label id="t_soc_end_label">% final</label>
            <input type="number" id="endSoc" min="0" max="100" required />
          </div>
          <div class="field">
            <label id="t_kwh_label">kWh entregados</label>
            <input type="number" step="0.01" id="kwh" required />
          </div>
          <div class="field">
            <label id="t_cost_total_label">Costo total</label>
            <input type="number" step="0.01" id="cost" required />
          </div>
          <div class="field">
            <label id="t_distance_label">Distancia desde la Ãºltima carga (mi)</label>
            <input type="number" step="0.1" id="km" required />
          </div>
          <div class="field">
            <label id="t_notes_label">Notas (opcional)</label>
            <input type="text" id="notes" />
          </div>
          <button type="submit" class="primary" id="t_save_charge_btn">Guardar carga</button>
        </form>
      </div>

      <div class="card">
        <h2 id="t_history_title">Historial de cargas</h2>
        <ul id="charges-list" class="list"></ul>
      </div>
    </section>

    <!-- VEHÃCULO -->
    <section id="vehicle" class="tab-panel">
      <div class="card">
        <h2 id="t_vehicle_data_title">Datos del vehÃ­culo</h2>
        <form id="vehicle-form" autocomplete="off">
          <div class="field">
            <label id="t_alias_label">Nombre / Alias</label>
            <input type="text" id="alias" placeholder="Ioniq 5 SEL AWD" />
          </div>
          <div class="field">
            <label id="t_brand_label">Marca</label>
            <input type="text" id="brand" />
          </div>
          <div class="field">
            <label id="t_model_label">Modelo</label>
            <input type="text" id="model" />
          </div>
          <div class="field">
            <label id="t_year_label">AÃ±o</label>
            <input type="number" id="year" />
          </div>
          <div class="field">
            <label id="t_usable_label">Capacidad usable (kWh)</label>
            <input type="number" step="0.1" id="usableKwh" />
          </div>
          <div class="field">
            <label id="t_rated_label">Consumo de ficha (kWh/100 km)</label>
            <input type="number" step="0.1" id="ratedConsumption" />
          </div>
          <button type="submit" class="primary" id="t_save_vehicle_btn">Guardar vehÃ­culo</button>
          <button type="button" class="secondary-btn" id="newVehicleInFormBtn">Nuevo vehÃ­culo</button>
        </form>
      </div>

      <div class="card">
        <h2 id="t_backup_title">Copias de seguridad</h2>
        <button id="exportBtn" class="secondary-btn">Exportar backup (JSON)</button>
        <input type="file" id="importFile" accept="application/json" style="margin-top:8px;font-size:12px;" />
        <p class="hint" id="t_backup_hint">
          Exporta un archivo JSON y guÃ¡rdalo en la nube. Para restaurar, selecciÃ³nalo nuevamente aquÃ­.
        </p>
      </div>
    </section>
  </main>
</div>

<script>
const STORAGE_KEY = "evlogbook-kairos-v5";
const KM_PER_MI = 1.60934;

let state = {
  theme: "dark",
  lang: "es",
  unit: "mi",   // por defecto millas
  vehicles: [],
  activeVehicleId: null,
  chargesByVehicle: {}
};

// ------- SEED VEHÃCULOS --------
function seedDefaultVehicles() {
  if (state.vehicles.length) return;

  const defaults = [
    { id:"hyundai Ioniq 5 SEL AWD", alias:"Ioniq 5 SEL AWD", brand:"Hyundai", model:"Ioniq 5 SEL AWD", year:"2023", usableKwh:"72.6", ratedConsumption:"17.0" },
    { id:"tesla-m3lr", alias:"Model 3 LR", brand:"Tesla", model:"Model 3 Long Range", year:"2023", usableKwh:"75", ratedConsumption:"15.5" },
    { id:"tesla-my", alias:"Model Y LR", brand:"Tesla", model:"Model Y Long Range", year:"2023", usableKwh:"75", ratedConsumption:"16.9" },
    { id:"rivian-r1t", alias:"R1T Large Pack", brand:"Rivian", model:"R1T", year:"2023", usableKwh:"135", ratedConsumption:"25" },
    { id:"kia-ev6", alias:"EV6 Wind", brand:"Kia", model:"EV6 Wind RWD", year:"2023", usableKwh:"72.5", ratedConsumption:"16.5" },
    { id:"ioniq6-rwd", alias:"Ioniq 6 RWD", brand:"Hyundai", model:"Ioniq 6 Long Range RWD", year:"2024", usableKwh:"72.6", ratedConsumption:"16.0" },
    { id:"ioniq6-awd", alias:"Ioniq 6 AWD", brand:"Hyundai", model:"Ioniq 6 Long Range AWD", year:"2024", usableKwh:"72.6", ratedConsumption:"18.0" },
    { id:"kona-ev", alias:"Kona EV", brand:"Hyundai", model:"Kona Electric 64kWh", year:"2022", usableKwh:"64", ratedConsumption:"14.7" },
    { id:"bmw-i4", alias:"i4 eDrive40", brand:"BMW", model:"i4 eDrive40", year:"2023", usableKwh:"80.7", ratedConsumption:"18.0" },
    { id:"merc-eqe", alias:"EQE 350+", brand:"Mercedes-Benz", model:"EQE 350+", year:"2023", usableKwh:"90.6", ratedConsumption:"19.0" }
  ];

  state.vehicles = defaults;
  defaults.forEach(v => { state.chargesByVehicle[v.id] = []; });
  state.activeVehicleId = defaults[0].id;
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      seedDefaultVehicles();
      return;
    }
    const data = JSON.parse(raw);
    state = Object.assign(state, data);
    Object.keys(state.chargesByVehicle || {}).forEach(id => {
      state.chargesByVehicle[id] = (state.chargesByVehicle[id] || []).map(c => {
        if (typeof c.kmBase === "number") return c;
        const km = typeof c.km === "number" ? c.km : 0;
        return Object.assign({}, c, { kmBase: km });
      });
    });
  } catch(e) { console.warn(e); }
}
function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function getActiveVehicle() {
  return state.vehicles.find(v => v.id === state.activeVehicleId) || null;
}
function getActiveCharges() {
  return state.chargesByVehicle[state.activeVehicleId] || [];
}
function kmToCurrent(km) {
  return state.unit === "km" ? km : km / KM_PER_MI;
}
function currentToKm(dist) {
  return state.unit === "km" ? dist : dist * KM_PER_MI;
}
function per100kmToUnit(v) {
  return state.unit === "km" ? v : v * KM_PER_MI;
}
function costPer100kmToUnit(v) {
  return state.unit === "km" ? v : v * KM_PER_MI;
}

// ------- I18N --------
const i18n = {
  es: {
    app_name: "EV Logbook",
    subtitle: "Kairos Edition",
    splash_tip: "Cargando datos de baterÃ­aâ€¦",
    tab_dashboard: "Dashboard",
    tab_charges: "Cargas",
    tab_vehicle: "VehÃ­culo",
    summary_title: "Resumen",
    range_label: "AutonomÃ­a estimada",
    cons_label_km: "Consumo medio (kWh/100 km)",
    cons_label_mi: "Consumo medio (kWh/100 mi)",
    cost_label_km: "Costo / 100 km",
    cost_label_mi: "Costo / 100 mi",
    charges_label: "Cargas registradas",
    battery_title: "BaterÃ­a / SOH",
    soh_label: "SOH estimado:",
    deg_label: "DegradaciÃ³n:",
    soh_hint: "Basado en consumo real vs. dato de fÃ¡brica. Es solo una estimaciÃ³n aproximada.",
    last_charge_title: "Ãšltima carga",
    last_charge_empty: "Crea un vehÃ­culo y registra tu primera carga.",
    chart_title: "Historial visual",
    chart_hint_km: "Consumo (kWh/100 km) de las Ãºltimas cargas del vehÃ­culo seleccionado.",
    chart_hint_mi: "Consumo (kWh/100 mi) de las Ãºltimas cargas del vehÃ­culo seleccionado.",
    new_charge_title: "Nueva carga",
    save_charge_btn: "Guardar carga",
    soc_start_label: "% inicio",
    soc_end_label: "% final",
    kwh_label: "kWh entregados",
    cost_total_label: "Costo total",
    distance_label_km: "Distancia desde la Ãºltima carga (km)",
    distance_label_mi: "Distancia desde la Ãºltima carga (mi)",
    notes_label: "Notas (opcional)",
    notes_placeholder: "EA, clima frÃ­o, autopista, etc.",
    history_title: "Historial de cargas",
    vehicle_data_title: "Datos del vehÃ­culo",
    alias_label: "Nombre / Alias",
    brand_label: "Marca",
    model_label: "Modelo",
    year_label: "AÃ±o",
    usable_label: "Capacidad usable (kWh)",
    rated_label_km: "Consumo de ficha (kWh/100 km)",
    rated_label_mi: "Consumo de ficha (kWh/100 mi)",
    save_vehicle_btn: "Guardar vehÃ­culo",
    new_vehicle_btn: "Nuevo vehÃ­culo",
    backup_title: "Copias de seguridad",
    backup_hint: "Exporta un archivo JSON y guÃ¡rdalo en la nube. Para restaurar, selecciÃ³nalo nuevamente aquÃ­.",
    export_backup_btn: "Exportar backup (JSON)",
    hint_no_vehicle: "Crea tu primer vehÃ­culo para empezar a registrar.",
    hint_no_charges: "AÃºn no hay cargas guardadas para este vehÃ­culo.",
    hint_create_vehicle_first: "Primero crea un vehÃ­culo en la pestaÃ±a â€œVehÃ­culoâ€.",
    hint_charges_for: name => "Guardando cargas para: " + name,
    print_btn: "Imprimir / Exportar PDF",
    vehicle_select_placeholder: "Selecciona un vehÃ­culo",
    alert_vehicle_min: "Coloca al menos un alias o marca/modelo.",
    alert_vehicle_saved: "VehÃ­culo guardado.",
    alert_check_numbers: "Revisa los campos numÃ©ricos.",
    alert_create_vehicle_first: "Primero crea un vehÃ­culo.",
    alert_backup_invalid: "Archivo de backup invÃ¡lido.",
    alert_backup_error: "Error al leer el backup.",
    alert_backup_restored: "Backup restaurado."
  },
  en: {
    app_name: "EV Logbook",
    subtitle: "Kairos Edition",
    splash_tip: "Loading battery dataâ€¦",
    tab_dashboard: "Dashboard",
    tab_charges: "Charges",
    tab_vehicle: "Vehicle",
    summary_title: "Summary",
    range_label: "Estimated range",
    cons_label_km: "Average consumption (kWh/100 km)",
    cons_label_mi: "Average consumption (kWh/100 mi)",
    cost_label_km: "Cost / 100 km",
    cost_label_mi: "Cost / 100 mi",
    charges_label: "Logged charges",
    battery_title: "Battery / SOH",
    soh_label: "Estimated SOH:",
    deg_label: "Degradation:",
    soh_hint: "Based on real consumption vs rated value. Only an approximate estimate.",
    last_charge_title: "Last charge",
    last_charge_empty: "Create a vehicle and log your first charge.",
    chart_title: "Visual history",
    chart_hint_km: "Consumption (kWh/100 km) for the last charges of the selected vehicle.",
    chart_hint_mi: "Consumption (kWh/100 mi) for the last charges of the selected vehicle.",
    new_charge_title: "New charge",
    save_charge_btn: "Save charge",
    soc_start_label: "% start",
    soc_end_label: "% end",
    kwh_label: "Delivered kWh",
    cost_total_label: "Total cost",
    distance_label_km: "Distance since last charge (km)",
    distance_label_mi: "Distance since last charge (mi)",
    notes_label: "Notes (optional)",
    notes_placeholder: "EA, cold weather, highway, etc.",
    history_title: "Charge history",
    vehicle_data_title: "Vehicle data",
    alias_label: "Name / Alias",
    brand_label: "Brand",
    model_label: "Model",
    year_label: "Year",
    usable_label: "Usable capacity (kWh)",
    rated_label_km: "Rated consumption (kWh/100 km)",
    rated_label_mi: "Rated consumption (kWh/100 mi)",
    save_vehicle_btn: "Save vehicle",
    new_vehicle_btn: "New vehicle",
    backup_title: "Backups",
    backup_hint: "Export a JSON file and store it safely. To restore, select it again here.",
    export_backup_btn: "Export backup (JSON)",
    hint_no_vehicle: "Create your first vehicle to start logging.",
    hint_no_charges: "No charges saved yet for this vehicle.",
    hint_create_vehicle_first: "Create a vehicle in the â€œVehicleâ€ tab first.",
    hint_charges_for: name => "Logging charges for: " + name,
    print_btn: "Print / Export PDF",
    vehicle_select_placeholder: "Select a vehicle",
    alert_vehicle_min: "Enter at least an alias or brand/model.",
    alert_vehicle_saved: "Vehicle saved.",
    alert_check_numbers: "Please check the numeric fields.",
    alert_create_vehicle_first: "Create a vehicle first.",
    alert_backup_invalid: "Invalid backup file.",
    alert_backup_error: "Error reading backup file.",
    alert_backup_restored: "Backup restored."
  }
};

function t(key, ...args) {
  const pack = i18n[state.lang] || i18n.es;
  const val = pack[key];
  if (typeof val === "function") return val.apply(null,args);
  return (val !== undefined && val !== null) ? val : key;
}

// ------- DOM --------
const langSelect = document.getElementById("langSelect");
const unitSelect = document.getElementById("unitSelect");
const themeToggle = document.getElementById("themeToggle");
const vehicleSelect = document.getElementById("vehicleSelect");
const tabButtons = document.querySelectorAll(".tab");
const panels = document.querySelectorAll(".tab-panel");
const statRange = document.getElementById("stat-range");
const statCons = document.getElementById("stat-consumption");
const statCost = document.getElementById("stat-cost");
const statCharges = document.getElementById("stat-charges");
const lastChargeText = document.getElementById("last-charge");
const batteryLevelEl = document.getElementById("batteryLevel");
const sohValue = document.getElementById("sohValue");
const degValue = document.getElementById("degValue");
const chartCanvas = document.getElementById("consumptionChart");
const chargeForm = document.getElementById("charge-form");
const chargesList = document.getElementById("charges-list");
const chargeVehicleHint = document.getElementById("chargeVehicleHint");
const vehicleForm = document.getElementById("vehicle-form");
const newVehicleInFormBtn = document.getElementById("newVehicleInFormBtn");
const exportBtn = document.getElementById("exportBtn");
const importFile = document.getElementById("importFile");
const printBtn = document.getElementById("printBtn");
const splashTip = document.getElementById("splashTip");

function applyTheme(theme) {
  state.theme = theme;
  if (theme === "light") {
    document.body.classList.add("light");
    themeToggle.textContent = "ðŸŒ™";
  } else {
    document.body.classList.remove("light");
    themeToggle.textContent = "ðŸŒ™";
  }
}
function applyTranslations() {
  document.getElementById("t_app_name").textContent = t("app_name");
  document.getElementById("t_subtitle").textContent = t("subtitle");
  splashTip.textContent = t("splash_tip");
  document.getElementById("tab_dashboard").textContent = t("tab_dashboard");
  document.getElementById("tab_charges").textContent = t("tab_charges");
  document.getElementById("tab_vehicle").textContent = t("tab_vehicle");
  document.getElementById("t_summary_title").textContent = t("summary_title");
  document.getElementById("t_range_label").textContent = t("range_label");
  document.getElementById("t_cons_label").textContent =
    state.unit === "km" ? t("cons_label_km") : t("cons_label_mi");
  document.getElementById("t_cost_label").textContent =
    state.unit === "km" ? t("cost_label_km") : t("cost_label_mi");
  document.getElementById("t_charges_label").textContent = t("charges_label");
  document.getElementById("t_battery_title").textContent = t("battery_title");
  document.getElementById("t_soh_label").textContent = t("soh_label");
  document.getElementById("t_deg_label").textContent = t("deg_label");
  document.getElementById("t_soh_hint").textContent = t("soh_hint");
  document.getElementById("t_last_charge_title").textContent = t("last_charge_title");
  printBtn.textContent = t("print_btn");
  document.getElementById("t_chart_title").textContent = t("chart_title");
  document.getElementById("t_chart_hint").textContent =
    state.unit === "km" ? t("chart_hint_km") : t("chart_hint_mi");
  document.getElementById("t_new_charge_title").textContent = t("new_charge_title");
  document.getElementById("t_soc_start_label").textContent = t("soc_start_label");
  document.getElementById("t_soc_end_label").textContent = t("soc_end_label");
  document.getElementById("t_kwh_label").textContent = t("kwh_label");
  document.getElementById("t_cost_total_label").textContent = t("cost_total_label");
  document.getElementById("t_distance_label").textContent =
    state.unit === "km" ? t("distance_label_km") : t("distance_label_mi");
  document.getElementById("t_notes_label").textContent = t("notes_label");
  document.getElementById("notes").placeholder = t("notes_placeholder");
  document.getElementById("t_save_charge_btn").textContent = t("save_charge_btn");
  document.getElementById("t_history_title").textContent = t("history_title");
  document.getElementById("t_vehicle_data_title").textContent = t("vehicle_data_title");
  document.getElementById("t_alias_label").textContent = t("alias_label");
  document.getElementById("t_brand_label").textContent = t("brand_label");
  document.getElementById("t_model_label").textContent = t("model_label");
  document.getElementById("t_year_label").textContent = t("year_label");
  document.getElementById("t_usable_label").textContent = t("usable_label");
  document.getElementById("t_rated_label").textContent =
    state.unit === "km" ? t("rated_label_km") : t("rated_label_mi");
  document.getElementById("t_save_vehicle_btn").textContent = t("save_vehicle_btn");
  newVehicleInFormBtn.textContent = t("new_vehicle_btn");
  document.getElementById("t_backup_title").textContent = t("backup_title");
  document.getElementById("t_backup_hint").textContent = t("backup_hint");
  exportBtn.textContent = t("export_backup_btn");
}
function renderVehicleSelect() {
  vehicleSelect.innerHTML = "";
  if (!state.vehicles.length) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = t("vehicle_select_placeholder");
    vehicleSelect.appendChild(opt);
    vehicleSelect.disabled = true;
    return;
  }
  vehicleSelect.disabled = false;
  state.vehicles.forEach(v => {
    const opt = document.createElement("option");
    opt.value = v.id;
    opt.textContent = v.alias || (v.brand + " " + v.model) || "EV";
    vehicleSelect.appendChild(opt);
  });
  if (!state.activeVehicleId) state.activeVehicleId = state.vehicles[0].id;
  vehicleSelect.value = state.activeVehicleId;
}
function renderVehicleForm() {
  const v = getActiveVehicle();
  vehicleForm.alias.value = v ? (v.alias || "") : "";
  vehicleForm.brand.value = v ? (v.brand || "") : "";
  vehicleForm.model.value = v ? (v.model || "") : "";
  vehicleForm.year.value = v ? (v.year || "") : "";
  vehicleForm.usableKwh.value = v ? (v.usableKwh || "") : "";
  vehicleForm.ratedConsumption.value = v ? (v.ratedConsumption || "") : "";
}
function updateChargeFormAvailability() {
  const v = getActiveVehicle();
  const inputs = chargeForm.querySelectorAll("input, button");
  if (!v) {
    inputs.forEach(el => el.disabled = true);
    chargeVehicleHint.textContent = t("hint_create_vehicle_first");
  } else {
    inputs.forEach(el => el.disabled = false);
    const name = v.alias || (v.brand + " " + v.model) || "EV";
    chargeVehicleHint.textContent = t("hint_charges_for", name);
  }
}
let chartCtx = null;
function drawChart(values) {
  if (!chartCanvas) return;
  if (!chartCtx) chartCtx = chartCanvas.getContext("2d");
  const w = chartCanvas.width = chartCanvas.clientWidth;
  const h = chartCanvas.height = chartCanvas.clientHeight;
  const ctx = chartCtx;
  ctx.clearRect(0,0,w,h);
  if (!values || !values.length) {
    ctx.fillStyle = "#888";
    ctx.font = "12px system-ui";
    ctx.fillText(state.lang === "es" ? "Sin datos suficientes." : "Not enough data.", 10, h/2);
    return;
  }
  const maxVal = Math.max.apply(null, values);
  const minVal = Math.min.apply(null, values);
  const pad = 8;
  const uw = w - pad*2;
  const uh = h - pad*2;
  ctx.strokeStyle = "rgba(255,255,255,0.3)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad, h-pad);
  ctx.lineTo(w-pad, h-pad);
  ctx.stroke();
  ctx.strokeStyle = "#2ecc71";
  ctx.lineWidth = 2;
  ctx.beginPath();
  for (let i=0;i<values.length;i++) {
    const v = values[i];
    const x = pad + uw * (i/Math.max(values.length-1,1));
    const norm = (v - minVal) / (maxVal - minVal || 1);
    const y = pad + uh * (1-norm);
    if (i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();
}
function formatDate(d) {
  return new Date(d).toLocaleString();
}
function renderChargesAndStats() {
  updateChargeFormAvailability();
  const v = getActiveVehicle();
  chargesList.innerHTML = "";
  if (!v) {
    chargesList.innerHTML = "<li class='list-item'>" + t("hint_no_vehicle") + "</li>";
    lastChargeText.textContent = t("last_charge_empty");
    statRange.textContent = "â€“";
    statCons.textContent = "â€“";
    statCost.textContent = "â€“";
    statCharges.textContent = "0";
    sohValue.textContent = "â€“";
    degValue.textContent = "â€“";
    batteryLevelEl.style.width = "30%";
    drawChart([]);
    return;
  }
  const charges = getActiveCharges();
  if (!charges.length) {
    chargesList.innerHTML = "<li class='list-item'>" + t("hint_no_charges") + "</li>";
    lastChargeText.textContent = t("hint_no_charges");
    statRange.textContent = "â€“";
    statCons.textContent = "â€“";
    statCost.textContent = "â€“";
    statCharges.textContent = "0";
    sohValue.textContent = "â€“";
    degValue.textContent = "â€“";
    batteryLevelEl.style.width = "45%";
    drawChart([]);
    return;
  }
  statCharges.textContent = String(charges.length);
  let totalKmBase = 0;
  let totalKwh = 0;
  let totalCost = 0;
  const chartVals = [];
  charges.slice().reverse().forEach(c => {
    totalKmBase += c.kmBase;
    totalKwh += c.kwh;
    totalCost += c.cost;
    const consPer100km = c.kmBase > 0 ? c.kwh / (c.kmBase/100) : 0;
    const consUnit = per100kmToUnit(consPer100km);
    chartVals.push(consUnit);
    const distShown = kmToCurrent(c.kmBase).toFixed(1);
    const unitTxt = state.unit;
    const effTxt = c.kmBase>0 ? consUnit.toFixed(1) + " kWh/100 " + unitTxt : "â€“";
    const li = document.createElement("li");
    li.className = "list-item";
    li.innerHTML =
      "<strong>"+formatDate(c.date)+"</strong><br>" +
      "<span>" +
      c.startSoc + "% â†’ " + c.endSoc + "% | " +
      c.kwh + " kWh | " +
      c.cost + " $ | " +
      distShown + " " + unitTxt +
      " (" + effTxt + ")" +
      "</span>" +
      (c.notes ? "<br><span>" + c.notes + "</span>" : "");
    chargesList.appendChild(li);
  });
  const last = charges[charges.length-1];
  const lastConsPer100km = last.kmBase>0 ? last.kwh / (last.kmBase/100) : 0;
  const lastConsUnit = per100kmToUnit(lastConsPer100km);
  const lastDistShown = kmToCurrent(last.kmBase).toFixed(1);
  const unitTxt = state.unit;
  lastChargeText.innerHTML =
    "<strong>"+formatDate(last.date)+"</strong><br>" +
    last.startSoc + "% â†’ " + last.endSoc + "% | " +
    last.kwh + " kWh | " +
    last.cost + " $ | " +
    lastDistShown + " " + unitTxt + "<br>" +
    "<span>" + lastConsUnit.toFixed(1) + " kWh/100 " + unitTxt + "</span>";
  if (totalKmBase>0 && totalKwh>0) {
    const avgPer100km = totalKwh / (totalKmBase/100);
    const avgUnit = per100kmToUnit(avgPer100km);
    statCons.textContent = avgUnit.toFixed(1) + " kWh/100 " + unitTxt;
    const costPerKm = totalCost / totalKmBase;
    const baseCost100 = costPerKm*100;
    const costUnit = costPer100kmToUnit(baseCost100);
    statCost.textContent = costUnit.toFixed(2) + " $ / 100 " + unitTxt;
    const usable = parseFloat(v.usableKwh || "0");
    if (usable>0 && avgPer100km>0) {
      const rangeKm = usable / (avgPer100km/100);
      const rangeShown = kmToCurrent(rangeKm);
      statRange.textContent = rangeShown.toFixed(0) + " " + unitTxt;
      const rated = parseFloat(v.ratedConsumption || "0");
      if (rated>0) {
        const theoKm = usable / (rated/100);
        let soh = (rangeKm / theoKm)*100;
        soh = Math.max(50, Math.min(120, soh));
        const degr = 100 - soh;
        sohValue.textContent = soh.toFixed(1) + " %";
        degValue.textContent = degr.toFixed(1) + " %";
        const width = Math.max(15, Math.min(100, soh));
        batteryLevelEl.style.width = width + "%";
      } else {
        sohValue.textContent = "â€“";
        degValue.textContent = "â€“";
        batteryLevelEl.style.width = "50%";
      }
    } else {
      statRange.textContent = "â€“";
      sohValue.textContent = "â€“";
      degValue.textContent = "â€“";
      batteryLevelEl.style.width = "50%";
    }
  } else {
    statRange.textContent = "â€“";
    statCons.textContent = "â€“";
    statCost.textContent = "â€“";
    sohValue.textContent = "â€“";
    degValue.textContent = "â€“";
    batteryLevelEl.style.width = "50%";
  }
  drawChart(chartVals.reverse());
}

// ------- EVENTOS UI --------
tabButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    tabButtons.forEach(b => b.classList.remove("active"));
    panels.forEach(p => p.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});
langSelect.addEventListener("change", () => {
  state.lang = langSelect.value;
  saveState();
  applyTranslations();
  renderVehicleSelect();
  renderVehicleForm();
  renderChargesAndStats();
});
unitSelect.addEventListener("change", () => {
  state.unit = unitSelect.value;
  saveState();
  applyTranslations();
  renderChargesAndStats();
});
themeToggle.addEventListener("click", () => {
  state.theme = state.theme === "dark" ? "light" : "dark";
  applyTheme(state.theme);
  saveState();
});
vehicleSelect.addEventListener("change", () => {
  state.activeVehicleId = vehicleSelect.value || null;
  saveState();
  renderVehicleForm();
  renderChargesAndStats();
});
newVehicleInFormBtn.addEventListener("click", () => {
  state.activeVehicleId = null;
  vehicleForm.reset();
  renderVehicleForm();
  renderChargesAndStats();
});
vehicleForm.addEventListener("submit", e => {
  e.preventDefault();
  const alias = vehicleForm.alias.value.trim();
  const brand = vehicleForm.brand.value.trim();
  const model = vehicleForm.model.value.trim();
  const year = vehicleForm.year.value.trim();
  const usableKwh = vehicleForm.usableKwh.value.trim();
  const ratedConsumption = vehicleForm.ratedConsumption.value.trim();
  if (!alias && !brand && !model) {
    alert(t("alert_vehicle_min"));
    return;
  }
  if (!state.activeVehicleId) {
    const id = "veh-" + Date.now().toString(36);
    const v = { id, alias, brand, model, year, usableKwh, ratedConsumption };
    state.vehicles.push(v);
    state.activeVehicleId = id;
    state.chargesByVehicle[id] = [];
  } else {
    const idx = state.vehicles.findIndex(v => v.id === state.activeVehicleId);
    if (idx>=0) {
      state.vehicles[idx] = Object.assign({}, state.vehicles[idx], {
        alias, brand, model, year, usableKwh, ratedConsumption
      });
    }
  }
  saveState();
  renderVehicleSelect();
  renderVehicleForm();
  renderChargesAndStats();
  alert(t("alert_vehicle_saved"));
});
chargeForm.addEventListener("submit", e => {
  e.preventDefault();
  const v = getActiveVehicle();
  if (!v) { alert(t("alert_create_vehicle_first")); return; }
  const startSoc = parseFloat(document.getElementById("startSoc").value);
  const endSoc = parseFloat(document.getElementById("endSoc").value);
  const kwh = parseFloat(document.getElementById("kwh").value);
  const cost = parseFloat(document.getElementById("cost").value);
  const dist = parseFloat(document.getElementById("km").value);
  const notes = document.getElementById("notes").value.trim();
  if ([startSoc,endSoc,kwh,cost,dist].some(function(v){ return isNaN(v); })) {
    alert(t("alert_check_numbers"));
    return;
  }
  const kmBase = currentToKm(dist);
  const vid = state.activeVehicleId;
  if (!state.chargesByVehicle[vid]) state.chargesByVehicle[vid] = [];
  state.chargesByVehicle[vid].push({
    date: new Date().toISOString(),
    startSoc: startSoc,
    endSoc: endSoc,
    kwh: kwh,
    cost: cost,
    kmBase: kmBase,
    notes: notes
  });
  saveState();
  chargeForm.reset();
  renderChargesAndStats();
});
exportBtn.addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "ev-logbook-kairos-backup.json";
  a.click();
  URL.revokeObjectURL(url);
});
importFile.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const data = JSON.parse(ev.target.result);
      if (!data.vehicles || !data.chargesByVehicle) {
        alert(t("alert_backup_invalid"));
        return;
      }
      state = Object.assign(state, data);
      saveState();
      applyTheme(state.theme || "dark");
      langSelect.value = state.lang || "es";
      unitSelect.value = state.unit || "mi";
      applyTranslations();
      renderVehicleSelect();
      renderVehicleForm();
      renderChargesAndStats();
      alert(t("alert_backup_restored"));
    } catch(err) {
      alert(t("alert_backup_error"));
    }
  };
  reader.readAsText(file);
});

printBtn.addEventListener("click", () => window.print());

// ------- INIT --------
loadState();
applyTheme(state.theme || "dark");
langSelect.value = state.lang || "es";
unitSelect.value = state.unit || "mi";
applyTranslations();
renderVehicleSelect();
renderVehicleForm();
renderChargesAndStats();

// ------- SPLASH --------
const splashEl = document.getElementById("splash");
const appRoot = document.querySelector(".app");
setTimeout(() => {
  if (splashEl) {
    splashEl.classList.add("hide");
    setTimeout(() => {
      splashEl.style.display = "none";
    }, 400);
  }
  if (appRoot) {
    appRoot.classList.add("ready");
  }
}, 600);

// ------- SERVICE WORKER --------
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("./service-worker.js")
      .catch(err => console.log("SW error", err));
  });
}
</script>
</body>
</html>